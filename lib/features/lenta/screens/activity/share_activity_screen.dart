// lib/features/lenta/screens/activity/share_activity_screen.dart
import 'dart:developer';
import 'dart:typed_data';
import 'dart:ui' as ui;

import 'package:cached_network_image/cached_network_image.dart';
import 'package:flutter/cupertino.dart';
import 'package:flutter/material.dart';
import 'package:flutter/rendering.dart';
import 'package:latlong2/latlong.dart';
import 'package:mapbox_maps_flutter/mapbox_maps_flutter.dart' as mapbox;
import 'package:share_plus/share_plus.dart';

import 'share_activity_bottom_sheet.dart';
import '../../../../core/theme/app_theme.dart';
import '../../../../core/utils/activity_format.dart';
import '../../../../core/widgets/app_bar.dart';
import '../../../../domain/models/activity_lenta.dart';

/// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
/// ğŸ”¹ Ğ­ĞšĞ ĞĞ ĞŸĞĞ”Ğ“ĞĞ¢ĞĞ’ĞšĞ˜ Ğ Ğ•ĞŸĞĞ¡Ğ¢Ğ Ğ¢Ğ Ğ•ĞĞ˜Ğ ĞĞ’ĞšĞ˜
/// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
/// Ğ¡Ğ¾Ğ´ĞµÑ€Ğ¶Ğ¸Ñ‚:
/// 1) AppBar Ñ Ğ·Ğ°Ğ³Ğ¾Ğ»Ğ¾Ğ²ĞºĞ¾Ğ¼ "ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ°"
/// 2) Ğ’ĞµÑ€Ñ…Ğ½ÑÑ ĞºĞ°Ñ€Ñ‚Ğ¸Ğ½ĞºÑƒ (ĞºĞ°Ğº Ğ² ĞºĞ°Ñ€Ñ‚Ğ¾Ñ‡ĞºĞµ Ñ‚Ñ€ĞµĞ½Ğ¸Ñ€Ğ¾Ğ²ĞºĞ¸)
/// 3) Ğ—Ğ°Ğ³Ğ¾Ğ»Ğ¾Ğ²Ğ¾Ğº Ğ²Ñ‹Ğ±Ğ¾Ñ€Ğ° Ñ„Ğ¾Ñ‚Ğ¾
/// 4) ĞœĞ¸Ğ½Ğ¸Ğ°Ñ‚ÑÑ€Ñ‹ Ñ„Ğ¾Ñ‚Ğ¾ Ñ Ğ¿Ğ¾Ğ´ÑĞ²ĞµÑ‚ĞºĞ¾Ğ¹ Ğ¿ĞµÑ€Ğ²Ğ¾Ğ¹
/// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
class ShareActivityScreen extends StatefulWidget {
  final Activity activity;

  const ShareActivityScreen({
    super.key,
    required this.activity,
  });

  @override
  State<ShareActivityScreen> createState() => _ShareActivityScreenState();
}

class _ShareActivityScreenState extends State<ShareActivityScreen> {
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // ğŸ”¹ Ğ”ĞĞĞĞ«Ğ• ĞœĞ•Ğ”Ğ˜Ğ Ğ˜ Ğ’Ğ«Ğ‘ĞĞ 
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  late final List<ShareMediaItem> _mediaItems;
  late int _selectedIndex;
  int _displayModeIndex = 0;
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // ğŸ”¹ Ğ˜ĞĞ¢Ğ•ĞĞ¡Ğ˜Ğ’ĞĞĞ¡Ğ¢Ğ¬ Ğ“Ğ ĞĞ”Ğ˜Ğ•ĞĞ¢ĞĞĞ“Ğ Ğ—ĞĞ¢Ğ•ĞœĞĞ•ĞĞ˜Ğ¯ (0.0 - 1.0)
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  late final ValueNotifier<double> _darknessOpacityNotifier;
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // ğŸ”¹ Ğ¦Ğ’Ğ•Ğ¢ Ğ¢Ğ•ĞšĞ¡Ğ¢Ğ: Ğ›Ğ®Ğ‘ĞĞ™ (Ğ‘Ğ•Ğ— Ğ›Ğ˜Ğ¨ĞĞ˜Ğ¥ ĞŸĞ•Ğ Ğ•Ğ¡Ğ¢Ğ ĞĞ•ĞĞ˜Ğ™)
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  late final ValueNotifier<Color> _textColorNotifier;
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // ğŸ”¹ Ğ¦Ğ’Ğ•Ğ¢ ĞœĞĞ Ğ¨Ğ Ğ£Ğ¢Ğ: Ğ›Ğ®Ğ‘ĞĞ™ (ĞĞ¢Ğ”Ğ•Ğ›Ğ¬ĞĞ ĞĞ¢ Ğ¢Ğ•ĞšĞ¡Ğ¢Ğ)
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  late final ValueNotifier<Color> _routeColorNotifier;
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // ğŸ”¹ Ğ¢ĞĞ›Ğ©Ğ˜ĞĞ Ğ›Ğ˜ĞĞ˜Ğ˜ ĞœĞĞ Ğ¨Ğ Ğ£Ğ¢Ğ (1.0 - 5.0 ĞŸĞ˜ĞšĞ¡Ğ•Ğ›Ğ•Ğ™)
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  late final ValueNotifier<double> _routeLineWidthNotifier;
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // ğŸ”¹ ĞšĞ›Ğ®Ğ§ Ğ”Ğ›Ğ¯ Ğ—ĞĞ¥Ğ’ĞĞ¢Ğ Ğ’Ğ•Ğ Ğ¥ĞĞ•Ğ“Ğ Ğ˜Ğ—ĞĞ‘Ğ ĞĞ–Ğ•ĞĞ˜Ğ¯
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  final GlobalKey _shareImageKey = GlobalKey();
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // ğŸ”¹ ĞšĞ›Ğ®Ğ§ Ğ”Ğ›Ğ¯ Ğ¡ĞšĞ Ğ«Ğ¢ĞĞ“Ğ Ğ­ĞšĞ¡ĞŸĞĞ Ğ¢Ğ Ğ¡ ĞŸĞ ĞĞ—Ğ ĞĞ§ĞĞ«Ğœ Ğ¤ĞĞĞĞœ
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  final GlobalKey _shareExportImageKey = GlobalKey();
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // ğŸ”¹ ĞŸĞ£Ğ¢Ğ¬ Ğš ĞŸĞ ĞĞ—Ğ ĞĞ§ĞĞĞœĞ£ ĞĞ¡Ğ¡Ğ•Ğ¢Ğ£
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  static const String _opacityAssetPath = 'assets/opacity.jpg';
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // ğŸ”¹ Ğ“ĞĞ Ğ˜Ğ—ĞĞĞ¢ĞĞ›Ğ¬ĞĞ«Ğ™ Ğ¡Ğ”Ğ’Ğ˜Ğ“ Ğ¤ĞĞ¢Ğ/ĞšĞĞ Ğ¢Ğ« (ĞšĞĞš Ğ’ Ğ Ğ•Ğ”ĞĞšĞ¢ĞĞ Ğ• ĞĞ‘Ğ Ğ•Ğ—ĞšĞ˜)
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  late final ValueNotifier<double> _panOffsetNotifier;
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // ğŸ”¹ ĞĞ˜Ğ–ĞĞ˜Ğ™ Ğ›Ğ˜Ğ¡Ğ¢: Ğ’Ğ«Ğ¡ĞĞ¢Ğ« ĞšĞĞš Ğ’ SEGMENT_DESCRIPTION
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  static const double _sheetCollapsedHeightPx = 100.0;
  final DraggableScrollableController _sheetController =
      DraggableScrollableController();

  @override
  void initState() {
    super.initState();

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // ğŸ”¹ Ğ¤ĞĞ ĞœĞ˜Ğ Ğ£Ğ•Ğœ Ğ•Ğ”Ğ˜ĞĞ«Ğ™ Ğ¡ĞŸĞ˜Ğ¡ĞĞš ĞœĞ•Ğ”Ğ˜Ğ
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    _mediaItems = _buildMediaItems(widget.activity);
    _selectedIndex = _mediaItems.isNotEmpty ? 0 : -1;

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // ğŸ”¹ NOTIFIER Ğ”Ğ›Ğ¯ Ğ—ĞĞ¢Ğ•ĞœĞĞ•ĞĞ˜Ğ¯ (ĞœĞ˜ĞĞ˜ĞœĞ£Ğœ ĞŸĞ•Ğ Ğ•Ğ¡Ğ¢Ğ ĞĞ•ĞĞ˜Ğ™)
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    _darknessOpacityNotifier = ValueNotifier<double>(0.0);
    _panOffsetNotifier = ValueNotifier<double>(0.0);
    _textColorNotifier = ValueNotifier<Color>(AppColors.surface);
    _routeColorNotifier = ValueNotifier<Color>(AppColors.brandPrimary);
    _routeLineWidthNotifier = ValueNotifier<double>(3.0);
  }

  @override
  void dispose() {
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // ğŸ”¹ ĞĞ§Ğ˜Ğ©ĞĞ•Ğœ NOTIFIER'Ğ« Ğ˜ ĞšĞĞĞ¢Ğ ĞĞ›Ğ›Ğ•Ğ  Ğ›Ğ˜Ğ¡Ğ¢Ğ
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    _darknessOpacityNotifier.dispose();
    _panOffsetNotifier.dispose();
    _textColorNotifier.dispose();
    _routeColorNotifier.dispose();
    _routeLineWidthNotifier.dispose();
    _sheetController.dispose();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // ğŸ”¹ Ğ˜Ğ¡ĞŸĞĞ›Ğ¬Ğ—Ğ£Ğ•Ğœ Ğ’Ğ¡Ğ• Ğ­Ğ›Ğ•ĞœĞ•ĞĞ¢Ğ« ĞœĞ•Ğ”Ğ˜Ğ (Ğ’ĞšĞ›Ğ®Ğ§ĞĞ¯ ĞĞ¡Ğ¡Ğ•Ğ¢ opacity.jpg)
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    final visibleItems = _mediaItems;
    final selectedItem = _currentSelectedItem;

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // ğŸ”¹ ĞĞ¡ĞĞĞ’ĞĞĞ™ ĞšĞĞĞ¢Ğ•Ğ™ĞĞ•Ğ  Ğ­ĞšĞ ĞĞĞ
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    return Scaffold(
      backgroundColor: AppColors.surface,
      appBar: const PaceAppBar(
        title: 'Ğ ĞµĞ¿Ğ¾ÑÑ‚',
        backgroundColor: AppColors.surface,
        showBottomDivider: false,
        elevation: 0,
        scrolledUnderElevation: 0,
      ),
      body: SafeArea(
        child: LayoutBuilder(
          builder: (context, constraints) {
            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            // ğŸ”¹ Ğ’Ğ«Ğ¡ĞĞ¢Ğ Ğ’Ğ•Ğ Ğ¥ĞĞ•Ğ“Ğ Ğ‘Ğ›ĞĞšĞ (Ğ¤ĞĞ¢Ğ 9:16 + ĞĞ¢Ğ¡Ğ¢Ğ£ĞŸ)
            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            final contentWidth =
                constraints.maxWidth - 48; // padding 24*2
            final imageHeight = contentWidth * (16 / 9);
            final topBlockHeight = 16 + imageHeight;

            return Stack(
              children: [
                // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                // ğŸ–¼ï¸ Ğ’Ğ•Ğ Ğ¥ĞĞ•Ğ• Ğ˜Ğ—ĞĞ‘Ğ ĞĞ–Ğ•ĞĞ˜Ğ• (ĞŸĞĞ” Ğ›Ğ˜Ğ¡Ğ¢ĞĞœ)
                // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                Positioned(
                  top: 0,
                  left: 0,
                  right: 0,
                  height: topBlockHeight,
                  child: Padding(
                    padding: const EdgeInsets.fromLTRB(24, 0, 24, 16),
                    child: Stack(
                      children: [
                        if (_isOpacitySelected)
                          Positioned.fill(
                            child: IgnorePointer(
                              child: RepaintBoundary(
                                key: _shareExportImageKey,
                                child: ValueListenableBuilder<double>(
                                  valueListenable: _darknessOpacityNotifier,
                                  builder: (context, darknessOpacity, child) {
                                  return ValueListenableBuilder<double>(
                                    valueListenable: _panOffsetNotifier,
                                    builder: (context, panOffset, _) {
                                      return _ShareTopImage(
                                        activity: widget.activity,
                                        selectedItem: selectedItem,
                                        heightFactor: 16 / 9,
                                        displayModeIndex: _displayModeIndex,
                                        isTransparentMode:
                                            _isOpacitySelected,
                                        darknessOpacity: darknessOpacity,
                                        textColorListenable:
                                            _textColorNotifier,
                                        routeColorNotifier:
                                            _routeColorNotifier,
                                        routeLineWidthNotifier:
                                            _routeLineWidthNotifier,
                                        panOffset: panOffset,
                                        onPanUpdate:
                                            (delta, maxOffset) {
                                          _panOffsetNotifier.value =
                                              (_panOffsetNotifier.value -
                                                      delta)
                                                  .clamp(
                                                      -maxOffset, maxOffset);
                                        },
                                      );
                                    },
                                  );
                                  },
                                ),
                              ),
                            ),
                          ),
                        RepaintBoundary(
                          key: _shareImageKey,
                          child: ValueListenableBuilder<double>(
                            valueListenable: _darknessOpacityNotifier,
                            builder: (context, darknessOpacity, child) {
                              return ValueListenableBuilder<double>(
                                valueListenable: _panOffsetNotifier,
                                builder: (context, panOffset, _) {
                                  return _ShareTopImage(
                                    activity: widget.activity,
                                    selectedItem: selectedItem,
                                    heightFactor: 16 / 9,
                                    displayModeIndex: _displayModeIndex,
                                    darknessOpacity: darknessOpacity,
                                    textColorListenable: _textColorNotifier,
                                    routeColorNotifier: _routeColorNotifier,
                                    routeLineWidthNotifier:
                                        _routeLineWidthNotifier,
                                    panOffset: panOffset,
                                    onPanUpdate: (delta, maxOffset) {
                                      _panOffsetNotifier.value =
                                          (_panOffsetNotifier.value - delta)
                                              .clamp(-maxOffset, maxOffset);
                                    },
                                  );
                                },
                              );
                            },
                          ),
                        ),
                      ],
                    ),
                  ),
                ),
                // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                // ğŸ“œ ĞĞ˜Ğ–ĞĞ˜Ğ™ Ğ›Ğ˜Ğ¡Ğ¢ ĞŸĞĞ’Ğ•Ğ Ğ¥ Ğ­ĞšĞ ĞĞĞ (ĞšĞĞš Ğ’ SEGMENT_DESCRIPTION)
                // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                DraggableScrollableSheet(
                  controller: _sheetController,
                  initialChildSize: (_sheetCollapsedHeightPx /
                          MediaQuery.sizeOf(context).height)
                      .clamp(0.0, 1.0),
                  minChildSize: (_sheetCollapsedHeightPx /
                          MediaQuery.sizeOf(context).height)
                      .clamp(0.0, 1.0),
                  maxChildSize: 0.95,
                  builder: (context, scrollController) {
                    return ShareActivityBottomSheetContent(
                      scrollController: scrollController,
                      dragController: _sheetController,
                      activity: widget.activity,
                      items: visibleItems,
                      selectedIndex: _selectedIndex,
                      onSelected: (index) {
                        setState(() {
                          _selectedIndex = index;
                          _panOffsetNotifier.value = 0.0;
                          final item = visibleItems[index];
                          if (item.isAsset &&
                              item.imageUrl == _opacityAssetPath) {
                            _displayModeIndex = 4;
                          } else if (_displayModeIndex >= 4) {
                            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                            // ğŸ”¹ 5-6 Ğ’Ğ˜Ğ”Ğ« Ğ¢ĞĞ›Ğ¬ĞšĞ Ğ”Ğ›Ğ¯ ĞŸĞ ĞĞ—Ğ ĞĞ§ĞĞĞ“Ğ Ğ¤ĞĞĞ
                            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                            _displayModeIndex = 0;
                          }
                        });
                      },
                      textColorNotifier: _textColorNotifier,
                      routeColorNotifier: _routeColorNotifier,
                      routeLineWidthNotifier: _routeLineWidthNotifier,
                      isMapSelected: _currentSelectedItem?.isMap == true,
                      displayModeIndex: _displayModeIndex,
                      onDisplayModeChanged: (index) {
                        setState(() {
                          _displayModeIndex = index;
                        });
                      },
                      isOpacitySelected: _isOpacitySelected,
                      darknessOpacityNotifier: _darknessOpacityNotifier,
                      onSharePressed: _onSharePressed,
                    );
                  },
                ),
              ],
            );
          },
        ),
      ),
    );
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // ğŸ”¹ ĞĞĞ–ĞĞ¢Ğ˜Ğ• "ĞŸĞĞ”Ğ•Ğ›Ğ˜Ğ¢Ğ¬Ğ¡Ğ¯": Ğ—ĞĞ¥Ğ’ĞĞ¢ + Ğ¡Ğ˜Ğ¡Ğ¢Ğ•ĞœĞĞ«Ğ™ Ğ‘ĞĞ¢Ğ¢ĞĞœ-Ğ¨Ğ˜Ğ¢
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  Future<void> _onSharePressed() async {
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // ğŸ”¹ Ğ—ĞĞ¥Ğ’ĞĞ¢Ğ«Ğ’ĞĞ•Ğœ Ğ˜Ğ—ĞĞ‘Ğ ĞĞ–Ğ•ĞĞ˜Ğ• Ğ¡ Ğ¢Ğ•ĞšĞ£Ğ©Ğ˜Ğœ Ğ ĞĞ¡ĞŸĞĞ›ĞĞ–Ğ•ĞĞ˜Ğ•Ğœ ĞĞ’Ğ•Ğ Ğ›Ğ•Ğ•Ğ’
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    final bytes = await _captureShareImageBytes();
    if (bytes == null || bytes.isEmpty) {
      log(
        'ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ ÑÑ„Ğ¾Ñ€Ğ¼Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ¸Ğ·Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ğµ Ğ´Ğ»Ñ ÑˆĞ°Ñ€Ğ¸Ğ½Ğ³Ğ°',
      );
      return;
    }
    if (!mounted) return;

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // ğŸ”¹ ĞĞ¢ĞšĞ Ğ«Ğ’ĞĞ•Ğœ ĞĞĞ¢Ğ˜Ğ’ĞĞ«Ğ™ Ğ‘ĞĞ¢Ğ¢ĞĞœ-Ğ¨Ğ˜Ğ¢ ĞŸĞĞ”Ğ•Ğ›Ğ˜Ğ¢Ğ¬Ğ¡Ğ¯
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    final box = context.findRenderObject() as RenderBox?;
    try {
      await Share.shareXFiles(
        [
          XFile.fromData(
            bytes,
            name: 'paceup_share.png',
            mimeType: 'image/png',
          ),
        ],
        sharePositionOrigin: box == null
            ? Rect.zero
            : box.localToGlobal(Offset.zero) & box.size,
      );
    } catch (e, stackTrace) {
      log(
        'ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¾Ñ‚ĞºÑ€Ñ‹Ñ‚Ğ¸Ñ ÑˆĞ°Ñ€Ğ¸Ğ½Ğ³Ğ° Ğ¸Ğ·Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ñ',
        error: e,
        stackTrace: stackTrace,
      );
    }
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // ğŸ”¹ Ğ—ĞĞ¥Ğ’ĞĞ¢ Ğ’Ğ•Ğ Ğ¥ĞĞ•Ğ“Ğ Ğ˜Ğ—ĞĞ‘Ğ ĞĞ–Ğ•ĞĞ˜Ğ¯ Ğ’ PNG-Ğ‘ĞĞ™Ğ¢Ğ«
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  Future<Uint8List?> _captureShareImageBytes() async {
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // ğŸ”¹ Ğ’Ğ«Ğ‘Ğ˜Ğ ĞĞ•Ğœ ĞšĞ›Ğ®Ğ§: ĞŸĞ ĞĞ—Ğ ĞĞ§ĞĞ«Ğ™ Ğ­ĞšĞ¡ĞŸĞĞ Ğ¢ Ğ¢ĞĞ›Ğ¬ĞšĞ Ğ”Ğ›Ğ¯ opacity.jpg
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    final key = _isOpacitySelected ? _shareExportImageKey : _shareImageKey;
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // ğŸ”¹ ĞŸĞĞ›Ğ£Ğ§ĞĞ•Ğœ RepaintBoundary Ğ”Ğ›Ğ¯ Ğ¡ĞĞ˜ĞœĞšĞ
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    final renderObject = key.currentContext?.findRenderObject();
    if (renderObject is! RenderRepaintBoundary) {
      log(
        'RenderRepaintBoundary Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½ Ğ´Ğ»Ñ Ğ·Ğ°Ñ…Ğ²Ğ°Ñ‚Ğ° Ğ¸Ğ·Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ñ',
      );
      return null;
    }
    final repaintBoundary = renderObject;

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // ğŸ”¹ Ğ Ğ•ĞĞ”Ğ•Ğ  Ğ’ PNG Ğ¡ Ğ£Ğ§Ğ•Ğ¢ĞĞœ PIXEL RATIO
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    final pixelRatio = MediaQuery.of(context).devicePixelRatio;
    for (var attempt = 0; attempt < 3; attempt++) {
      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      // ğŸ”¹ Ğ‘Ğ•Ğ—ĞĞŸĞĞ¡ĞĞĞ¯ ĞŸĞ ĞĞ’Ğ•Ğ ĞšĞ debugNeedsPaint (ĞœĞĞ–Ğ•Ğ¢ Ğ‘Ğ«Ğ¢Ğ¬ ĞĞ•Ğ”ĞĞ¡Ğ¢Ğ£ĞŸĞ•Ğ)
      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      var needsPaint = false;
      try {
        needsPaint = repaintBoundary.debugNeedsPaint;
      } catch (e) {
        log(
          'debugNeedsPaint Ğ½ĞµĞ´Ğ¾ÑÑ‚ÑƒĞ¿ĞµĞ½, Ğ¿Ñ€Ğ¾Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºÑƒ',
          error: e,
        );
      }
      if (needsPaint) {
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // ğŸ”¹ Ğ–Ğ”Ğ•Ğœ ĞšĞĞ”Ğ , Ğ§Ğ¢ĞĞ‘Ğ« RENDEROBJECT Ğ£Ğ¡ĞŸĞ•Ğ› ĞŸĞ ĞĞ Ğ˜Ğ¡ĞĞ’ĞĞ¢Ğ¬Ğ¡Ğ¯
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        await WidgetsBinding.instance.endOfFrame;
      }
      try {
        final image = await repaintBoundary.toImage(pixelRatio: pixelRatio);
        final byteData = await image.toByteData(
          format: ui.ImageByteFormat.png,
        );
        image.dispose();
        return byteData?.buffer.asUint8List();
      } catch (e, stackTrace) {
        log(
          'ĞÑˆĞ¸Ğ±ĞºĞ° Ğ·Ğ°Ñ…Ğ²Ğ°Ñ‚Ğ° Ğ¸Ğ·Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ñ (Ğ¿Ğ¾Ğ¿Ñ‹Ñ‚ĞºĞ° ${attempt + 1})',
          error: e,
          stackTrace: stackTrace,
        );
        await WidgetsBinding.instance.endOfFrame;
      }
    }
    return null;
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // ğŸ”¹ Ğ¢Ğ•ĞšĞ£Ğ©Ğ˜Ğ™ Ğ’Ğ«Ğ‘Ğ ĞĞĞĞ«Ğ™ Ğ­Ğ›Ğ•ĞœĞ•ĞĞ¢
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  ShareMediaItem? get _currentSelectedItem =>
      (_selectedIndex >= 0 && _selectedIndex < _mediaItems.length)
          ? _mediaItems[_selectedIndex]
          : null;

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // ğŸ”¹ ĞŸĞ ĞĞ—Ğ ĞĞ§ĞĞ«Ğ™ Ğ Ğ•Ğ–Ğ˜Ğœ Ğ”Ğ›Ğ¯ opacity.jpg
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  bool get _isOpacitySelected =>
      _currentSelectedItem?.isAsset == true &&
      _currentSelectedItem?.imageUrl == _opacityAssetPath;
}

/// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
/// ğŸ”¹ Ğ’Ğ•Ğ Ğ¥ĞĞ•Ğ• Ğ˜Ğ—ĞĞ‘Ğ ĞĞ–Ğ•ĞĞ˜Ğ•: Ğ¤ĞĞ¢Ğ/ĞšĞĞ Ğ¢Ğ/Ğ”Ğ•Ğ¤ĞĞ›Ğ¢
/// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
class _ShareTopImage extends StatelessWidget {
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // ğŸ”¹ ĞŸĞ£Ğ¢Ğ¬ Ğš ĞŸĞ ĞĞ—Ğ ĞĞ§ĞĞĞœĞ£ ĞĞ¡Ğ¡Ğ•Ğ¢Ğ£ (Ğ›ĞĞšĞĞ›Ğ¬ĞĞ Ğ”Ğ›Ğ¯ Ğ’Ğ˜Ğ”Ğ–Ğ•Ğ¢Ğ)
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  static const String _opacityAssetPath = 'assets/opacity.jpg';
  final Activity activity;
  final ShareMediaItem? selectedItem;
  final double heightFactor;
  final int displayModeIndex;
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // ğŸ”¹ Ğ Ğ•Ğ–Ğ˜Ğœ ĞŸĞ ĞĞ—Ğ ĞĞ§ĞĞĞ“Ğ Ğ¤ĞĞĞ Ğ”Ğ›Ğ¯ opacity.jpg
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  final bool isTransparentMode;
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // ğŸ”¹ Ğ˜ĞĞ¢Ğ•ĞĞ¡Ğ˜Ğ’ĞĞĞ¡Ğ¢Ğ¬ Ğ“Ğ ĞĞ”Ğ˜Ğ•ĞĞ¢ĞĞĞ“Ğ Ğ—ĞĞ¢Ğ•ĞœĞĞ•ĞĞ˜Ğ¯ (0.0 - 1.0)
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  final double darknessOpacity;
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // ğŸ”¹ Ğ¦Ğ’Ğ•Ğ¢ Ğ¢Ğ•ĞšĞ¡Ğ¢Ğ: Ğ›Ğ®Ğ‘ĞĞ™
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  final ValueNotifier<Color> textColorListenable;
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // ğŸ”¹ Ğ¦Ğ’Ğ•Ğ¢ ĞœĞĞ Ğ¨Ğ Ğ£Ğ¢Ğ: Ğ›Ğ®Ğ‘ĞĞ™ (ĞĞ¢Ğ”Ğ•Ğ›Ğ¬ĞĞ ĞĞ¢ Ğ¢Ğ•ĞšĞ¡Ğ¢Ğ)
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  final ValueNotifier<Color> routeColorNotifier;
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // ğŸ”¹ Ğ¢ĞĞ›Ğ©Ğ˜ĞĞ Ğ›Ğ˜ĞĞ˜Ğ˜ ĞœĞĞ Ğ¨Ğ Ğ£Ğ¢Ğ (1.0 - 5.0 ĞŸĞ˜ĞšĞ¡Ğ•Ğ›Ğ•Ğ™)
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  final ValueNotifier<double> routeLineWidthNotifier;
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // ğŸ”¹ Ğ“ĞĞ Ğ˜Ğ—ĞĞĞ¢ĞĞ›Ğ¬ĞĞ«Ğ™ Ğ¡Ğ”Ğ’Ğ˜Ğ“ (Ğ Ğ•Ğ”ĞĞšĞ¢ĞĞ  ĞĞ‘Ğ Ğ•Ğ—ĞšĞ˜) Ğ˜ ĞšĞĞ›Ğ›Ğ‘Ğ­Ğš
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  final double panOffset;
  final void Function(double delta, double maxOffset) onPanUpdate;

  const _ShareTopImage({
    required this.activity,
    required this.selectedItem,
    this.heightFactor = 16 / 9,
    required this.displayModeIndex,
    this.isTransparentMode = false,
    this.darknessOpacity = 0.0,
    required this.textColorListenable,
    required this.routeColorNotifier,
    required this.routeLineWidthNotifier,
    this.panOffset = 0.0,
    required this.onPanUpdate,
  });

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // ğŸ”¹ ĞŸĞĞ›Ğ£Ğ§Ğ•ĞĞ˜Ğ• Ğ˜ĞšĞĞĞšĞ˜ Ğ’Ğ˜Ğ”Ğ Ğ¡ĞŸĞĞ Ğ¢Ğ
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  IconData _getSportIcon(String activityType) {
    final type = activityType.toLowerCase();
    if (type == 'run' || type == 'running' || type == 'indoor-running') {
      return Icons.directions_run;
    } else if (type == 'bike' ||
        type == 'cycling' ||
        type == 'bicycle' ||
        type == 'indoor-cycling') {
      return Icons.directions_bike;
    } else if (type == 'swim' || type == 'swimming') {
      return Icons.pool;
    } else if (type == 'ski' || type == 'skiing') {
      return Icons.downhill_skiing;
    } else if (type == 'walking' || type == 'hiking') {
      return Icons.directions_walk;
    }
    // Ğ”ĞµÑ„Ğ¾Ğ»Ñ‚Ğ½Ğ°Ñ Ğ¸ĞºĞ¾Ğ½ĞºĞ° Ğ´Ğ»Ñ Ğ±ĞµĞ³Ğ°
    return Icons.directions_run;
  }
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // ğŸ”¹ ĞĞŸĞ Ğ•Ğ”Ğ•Ğ›Ğ¯Ğ•Ğœ, Ğ§Ğ¢Ğ ĞšĞĞĞ¢Ğ•ĞĞ¢ â€” Ğ­Ğ¢Ğ ĞšĞĞ Ğ¢Ğ (Ğ”Ğ›Ğ¯ Ğ˜ĞĞ¢Ğ•Ğ ĞĞšĞ¢Ğ˜Ğ’Ğ)
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  bool _isMapContent() {
    final hasPoints = activity.points.isNotEmpty;
    if (selectedItem != null) {
      return selectedItem!.isMap && hasPoints;
    }
    return activity.mediaImages.isEmpty && hasPoints;
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // ğŸ”¹ ĞŸĞ ĞĞ’Ğ•Ğ ĞšĞ Ğ¢Ğ•ĞœĞĞĞ“Ğ Ğ¦Ğ’Ğ•Ğ¢Ğ Ğ”Ğ›Ğ¯ ĞšĞĞĞ¢Ğ ĞĞ¡Ğ¢ĞĞĞ“Ğ Ğ¤ĞĞĞ
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  bool _isDarkTextColor(Color color) {
    return color.computeLuminance() < 0.5;
  }

  @override
  Widget build(BuildContext context) {
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // ğŸ”¹ Ğ ĞĞ¡Ğ¡Ğ§Ğ•Ğ¢ Ğ’Ğ«Ğ¡ĞĞ¢Ğ«: 9:16 (Stories â€” Instagram, Telegram, VK)
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    return LayoutBuilder(
      builder: (context, constraints) {
        final width = constraints.maxWidth;
        final height = width * heightFactor;
        final isMapContent = _isMapContent();
        final maxOffset = width * 0.5;
        final alignmentX = maxOffset == 0
            ? 0.0
            : (panOffset / maxOffset).clamp(-1.0, 1.0);
        final effectiveAlignmentX = isMapContent ? 0.0 : alignmentX;
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // ğŸ”¹ ĞŸĞ ĞĞ—Ğ ĞĞ§ĞĞ«Ğ™ Ğ¤ĞĞ: ĞœĞ•ĞĞ¯Ğ•Ğœ ĞŸĞĞ”Ğ›ĞĞ–ĞšĞ£ ĞŸĞ Ğ¦Ğ’Ğ•Ğ¢Ğ£ Ğ¢Ğ•ĞšĞ¡Ğ¢Ğ Ğ”Ğ˜ĞĞĞœĞ˜Ğ§Ğ•Ğ¡ĞšĞ˜
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        final isOpacityAssetSelected =
            selectedItem?.isAsset == true &&
            selectedItem?.imageUrl == _opacityAssetPath;
        final imageContent = isOpacityAssetSelected
            ? ValueListenableBuilder<Color>(
                valueListenable: textColorListenable,
                builder: (context, _, __) {
                  return _buildTopImageContent(
                    context,
                    width,
                    height,
                    isTransparentMode: isTransparentMode,
                    alignmentX: effectiveAlignmentX,
                  );
                },
              )
            : _buildTopImageContent(
                context,
                width,
                height,
                isTransparentMode: isTransparentMode,
                alignmentX: effectiveAlignmentX,
              );
        final panReadyContent = isMapContent
            ? imageContent
            : GestureDetector(
                onHorizontalDragUpdate: (details) {
                  onPanUpdate(details.delta.dx, maxOffset);
                },
                child: imageContent,
              );

        return SizedBox(
          width: width,
          height: height,
          child: ClipRRect(
            borderRadius: BorderRadius.circular(AppRadius.lg),
            child: Stack(
              fit: StackFit.expand,
              clipBehavior: Clip.hardEdge,
              children: [
                // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                // ğŸ”¹ Ğ¤ĞĞ¢Ğ/ĞšĞĞ Ğ¢Ğ: Ğ“ĞĞ Ğ˜Ğ—ĞĞĞ¢ĞĞ›Ğ¬ĞĞ«Ğ™ Ğ¡Ğ”Ğ’Ğ˜Ğ“ (ĞšĞĞš Ğ’ Ğ Ğ•Ğ”ĞĞšĞ¢ĞĞ Ğ• ĞĞ‘Ğ Ğ•Ğ—ĞšĞ˜)
                // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                panReadyContent,
                // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                // ğŸŒ‘ Ğ ĞĞ”Ğ˜ĞĞ›Ğ¬ĞĞĞ• Ğ—ĞĞ¢Ğ•ĞœĞĞ•ĞĞ˜Ğ•: Ğ¾Ñ‚ Ñ†ĞµĞ½Ñ‚Ñ€Ğ° Ğº ĞºÑ€Ğ°ÑĞ¼
                // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                if (!isTransparentMode && darknessOpacity > 0.0)
                  Positioned.fill(
                    child: IgnorePointer(
                      child: Container(
                        decoration: BoxDecoration(
                          gradient: RadialGradient(
                            center: Alignment.center,
                            radius: 1.0,
                            colors: [
                              Colors.transparent,
                              Colors.black.withValues(
                                alpha: darknessOpacity,
                              ),
                            ],
                            stops: [0.0, 1.0],
                          ),
                        ),
                      ),
                    ),
                  ),
                // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                // ğŸ–¼ï¸ ĞĞ’Ğ•Ğ Ğ›Ğ•Ğ™ Ğ˜Ğ— ĞĞ¡Ğ¡Ğ•Ğ¢ĞĞ’: Ğ¿Ğ¾Ğ·Ğ¸Ñ†Ğ¸Ñ Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ñ‚ Ğ¾Ñ‚ Ğ²Ñ‹Ğ±Ñ€Ğ°Ğ½Ğ½Ğ¾Ğ³Ğ¾ Ğ²Ğ¸Ğ´Ğ°
                // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                // ğŸ§© ĞŸĞĞ—Ğ˜Ğ¦Ğ˜Ğ¯ Ğ›ĞĞ“ĞĞ¢Ğ˜ĞŸĞ: 4/5 Ğ’Ğ˜Ğ” â€” ĞŸĞ Ğ¦Ğ•ĞĞ¢Ğ Ğ£ (Ğ”Ğ›Ğ¯ ĞŸĞ ĞĞ—Ğ ĞĞ§ĞĞĞ“Ğ Ğ¤ĞĞĞ)
                // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                // ğŸ§© ĞĞ’Ğ•Ğ Ğ›Ğ•Ğ™ Ğ›ĞĞ“ĞĞ¢Ğ˜ĞŸĞ Ğ˜ ĞœĞ•Ğ¢Ğ Ğ˜Ğš (ĞĞ‘ĞĞĞ’Ğ›Ğ¯Ğ•Ğ¢Ğ¡Ğ¯ Ğ¢ĞĞ›Ğ¬ĞšĞ ĞŸĞ Ğ¦Ğ’Ğ•Ğ¢Ğ£)
                // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                ValueListenableBuilder<Color>(
                  valueListenable: textColorListenable,
                  builder: (context, textColor, _) {
                    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                    // ğŸ”¹ Ğ Ğ•Ğ–Ğ˜ĞœĞ« Ğ¦Ğ•ĞĞ¢Ğ ĞĞ›Ğ¬ĞĞĞ“Ğ ĞĞ’Ğ•Ğ Ğ›Ğ•Ğ¯ (ĞŸĞ ĞĞ—Ğ ĞĞ§ĞĞ«Ğ™ Ğ¤ĞĞ)
                    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                    final isCenteredMode =
                        displayModeIndex == 4 || displayModeIndex == 5;
                    final showRouteMini = displayModeIndex == 5;

                    return Positioned.fill(
                      child: Stack(
                        fit: StackFit.expand,
                        children: [
                          Positioned(
                            top: displayModeIndex == 1
                                ? null
                                : isCenteredMode
                                    ? null
                                    : (displayModeIndex == 0 ||
                                            displayModeIndex == 2 ||
                                            displayModeIndex == 3)
                                        ? 16
                                        : 12,
                            bottom: displayModeIndex == 1
                                ? 12
                                : isCenteredMode
                                    ? null
                                    : null,
                            left: displayModeIndex == 3
                                ? 16
                                : isCenteredMode
                                    ? null
                                    : null,
                            right: displayModeIndex == 3
                                ? null
                                : isCenteredMode
                                    ? null
                                    : 20,
                            child: isCenteredMode
                                ? Center(
                                    child: Column(
                                      mainAxisSize: MainAxisSize.min,
                                      children: [
                                        Image.asset(
                                          'assets/white_text.png',
                                          width: 90,
                                          fit: BoxFit.contain,
                                          color: textColor,
                                          colorBlendMode: BlendMode.srcIn,
                                        ),
                                        const SizedBox(height: 16),
                                        if (showRouteMini)
                                          ValueListenableBuilder<Color>(
                                            valueListenable:
                                                routeColorNotifier,
                                            builder: (context, routeColor, _) {
                                              return ValueListenableBuilder<
                                                  double>(
                                                valueListenable:
                                                    routeLineWidthNotifier,
                                                builder:
                                                    (context, lineWidth, __) {
                                                  return SizedBox(
                                                    width: 64,
                                                    height: 64,
                                                    child: CustomPaint(
                                                      painter:
                                                          _MiniRoutePainter(
                                                        points: activity.points
                                                            .map(
                                                              (c) => LatLng(
                                                                c.lat,
                                                                c.lng,
                                                              ),
                                                            )
                                                            .toList(
                                                              growable: false,
                                                            ),
                                                        lineColor: routeColor,
                                                        lineWidth: lineWidth,
                                                      ),
                                                    ),
                                                  );
                                                },
                                              );
                                            },
                                          )
                                        else
                                          Icon(
                                            _getSportIcon(activity.type),
                                            size: 32,
                                            color: textColor,
                                          ),
                                        const SizedBox(height: 12),
                                        _buildOverlayMetricsColumnCentered(
                                          context,
                                          textColor: textColor,
                                        ),
                                      ],
                                    ),
                                  )
                                : Image.asset(
                                    'assets/white_logo.png',
                                    width: 100,
                                    fit: BoxFit.contain,
                                    color: textColor,
                                    colorBlendMode: BlendMode.srcIn,
                                  ),
                          ),
                          if (displayModeIndex == 2)
                            Positioned(
                              left: 16,
                              bottom: 12,
                              child: _buildOverlayMetricsColumn(
                                context,
                                textColor: textColor,
                              ),
                            )
                          else if (displayModeIndex == 3)
                            Positioned(
                              right: 16,
                              bottom: 12,
                              child: _buildOverlayMetricsColumn(
                                context,
                                isRightAligned: true,
                                textColor: textColor,
                              ),
                            )
                          else if (!isCenteredMode)
                            Positioned(
                              left: 16,
                              right: 16,
                              top: displayModeIndex == 1 ? 12 : null,
                              bottom: displayModeIndex == 1 ? null : 12,
                              child: _buildOverlayMetricsRow(
                                context,
                                textColor: textColor,
                              ),
                            ),
                        ],
                      ),
                    );
                  },
                ),
              ],
            ),
          ),
        );
      },
    );
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // ğŸ”¹ ĞšĞĞĞ¢Ğ•ĞĞ¢ Ğ˜Ğ—ĞĞ‘Ğ ĞĞ–Ğ•ĞĞ˜Ğ¯: Ğ¤ĞĞ¢Ğ â†’ ĞšĞĞ Ğ¢Ğ â†’ Ğ”Ğ•Ğ¤ĞĞ›Ğ¢
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  Widget _buildTopImageContent(
    BuildContext context,
    double width,
    double height, {
    bool isTransparentMode = false,
    double alignmentX = 0.0,
  }) {
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // ğŸ”¹ ĞŸĞ ĞĞ—Ğ ĞĞ§ĞĞ«Ğ™ Ğ¤ĞĞ: Ğ¢ĞĞ›Ğ¬ĞšĞ ĞĞ’Ğ•Ğ Ğ›Ğ•Ğ˜
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    if (isTransparentMode) {
      return const ColoredBox(
        color: Colors.transparent,
      );
    }
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // ğŸ”¹ Ğ•Ğ¡Ğ›Ğ˜ Ğ’Ğ«Ğ‘Ğ ĞĞ ĞšĞĞĞšĞ Ğ•Ğ¢ĞĞ«Ğ™ Ğ­Ğ›Ğ•ĞœĞ•ĞĞ¢ â€” ĞŸĞĞšĞĞ—Ğ«Ğ’ĞĞ•Ğœ Ğ•Ğ“Ğ
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    if (selectedItem != null) {
      if (selectedItem!.isMap && activity.points.isNotEmpty) {
        return _buildMapImage();
      }
      if (!selectedItem!.isMap && selectedItem!.imageUrl != null) {
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // ğŸ”¹ Ğ•Ğ¡Ğ›Ğ˜ Ğ¢Ğ•ĞšĞ¡Ğ¢ Ğ¢Ğ•ĞœĞĞ«Ğ™ Ğ˜ opacity.jpg â€” Ğ˜Ğ¡ĞŸĞĞ›Ğ¬Ğ—Ğ£Ğ•Ğœ opacity_white.png
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    final isDarkTextColor =
        _isDarkTextColor(textColorListenable.value);
    final imageUrl = selectedItem!.imageUrl == 'assets/opacity.jpg' &&
            isDarkTextColor
        ? 'assets/opacity_white.png'
        : selectedItem!.imageUrl!;
        return _buildPhotoImage(
          context,
          width,
          height,
          imageUrl,
          isAsset: selectedItem!.isAsset,
          alignmentX: alignmentX,
        );
      }
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // ğŸ”¹ 1. Ğ•Ğ¡Ğ›Ğ˜ Ğ•Ğ¡Ğ¢Ğ¬ Ğ¤ĞĞ¢Ğ â€” ĞŸĞĞšĞĞ—Ğ«Ğ’ĞĞ•Ğœ ĞŸĞ•Ğ Ğ’ĞĞ•
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    if (activity.mediaImages.isNotEmpty) {
      return _buildPhotoImage(
        context,
        width,
        height,
        activity.mediaImages.first,
        alignmentX: alignmentX,
      );
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // ğŸ”¹ 2. Ğ•Ğ¡Ğ›Ğ˜ Ğ¤ĞĞ¢Ğ ĞĞ•Ğ¢, ĞĞ Ğ•Ğ¡Ğ¢Ğ¬ ĞœĞĞ Ğ¨Ğ Ğ£Ğ¢ â€” ĞŸĞĞšĞĞ—Ğ«Ğ’ĞĞ•Ğœ ĞšĞĞ Ğ¢Ğ£
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    if (activity.points.isNotEmpty) {
      return _buildMapImage();
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // ğŸ”¹ 3. Ğ•Ğ¡Ğ›Ğ˜ ĞĞ•Ğ¢ Ğ¤ĞĞ¢Ğ Ğ˜ ĞœĞĞ Ğ¨Ğ Ğ£Ğ¢Ğ â€” Ğ”Ğ•Ğ¤ĞĞ›Ğ¢ĞĞĞ¯ ĞšĞĞ Ğ¢Ğ˜ĞĞšĞ
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    final defaultImagePath = getDefaultNoRouteImagePath(activity.type);

    return Image.asset(
      defaultImagePath,
      fit: BoxFit.cover,
      alignment: Alignment(alignmentX, 0),
      errorBuilder: (context, error, stackTrace) => Container(
        color: AppColors.twinphoto,
        child: const Center(
          child: Icon(
            CupertinoIcons.photo,
            size: 40,
            color: AppColors.scrim20,
          ),
        ),
      ),
    );
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // ğŸ”¹ ĞŸĞĞ¡Ğ¢Ğ ĞĞ•ĞĞ˜Ğ• Ğ¤ĞĞ¢Ğ
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  Widget _buildPhotoImage(
    BuildContext context,
    double width,
    double height,
    String imageUrl, {
    bool isAsset = false,
    double alignmentX = 0.0,
  }) {
    if (isAsset) {
      return Image.asset(
        imageUrl,
        fit: BoxFit.cover,
        alignment: Alignment(alignmentX, 0),
        width: width,
        height: height,
        errorBuilder: (context, error, stackTrace) => Container(
          color: AppColors.twinphoto,
          child: const Center(
            child: Icon(
              CupertinoIcons.photo,
              size: 40,
              color: AppColors.scrim20,
            ),
          ),
        ),
      );
    }

    // ĞĞ° ÑĞºÑ€Ğ°Ğ½Ğµ Ñ€ĞµĞ¿Ğ¾ÑÑ‚Ğ° Ğ´ĞµĞºĞ¾Ğ´Ğ¸Ñ€ÑƒĞµĞ¼ Ñ„Ğ¾Ñ‚Ğ¾ Ğ² Ğ¿Ğ¾Ğ»Ğ½Ğ¾Ğ¼ Ñ€Ğ°Ğ·Ñ€ĞµÑˆĞµĞ½Ğ¸Ğ¸ Ğ´Ğ»Ñ Ğ½Ğ°Ğ¸Ğ»ÑƒÑ‡ÑˆĞµĞ³Ğ¾ ĞºĞ°Ñ‡ĞµÑÑ‚Ğ²Ğ°
    return CachedNetworkImage(
      imageUrl: imageUrl,
      fit: BoxFit.cover,
      alignment: Alignment(alignmentX, 0),
      placeholder: (context, url) => Container(
        color: AppColors.twinphoto,
        child: const Center(
          child: CupertinoActivityIndicator(),
        ),
      ),
      errorWidget: (context, url, error) => Container(
        color: AppColors.twinphoto,
        child: const Center(
          child: Icon(
            CupertinoIcons.photo,
            size: 40,
            color: AppColors.scrim20,
          ),
        ),
      ),
    );
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // ğŸ”¹ ĞŸĞĞ¡Ğ¢Ğ ĞĞ•ĞĞ˜Ğ• ĞšĞĞ Ğ¢Ğ«
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  Widget _buildMapImage() {
    final points = activity.points.map((c) => LatLng(c.lat, c.lng)).toList();

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // ğŸ”¹ Ğ˜ĞĞ¢Ğ•Ğ ĞĞšĞ¢Ğ˜Ğ’ĞĞĞ¯ ĞšĞĞ Ğ¢Ğ MAPBOX (ĞŸĞĞ/Ğ—Ğ£Ğœ) Ğ¡ Ğ¢Ğ Ğ•ĞšĞĞœ
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    return _ShareRouteMap(
      points: points,
      lineColorNotifier: routeColorNotifier,
      lineWidthNotifier: routeLineWidthNotifier,
    );
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // ğŸ”¹ ĞœĞ•Ğ¢Ğ Ğ˜ĞšĞ˜ ĞŸĞĞ’Ğ•Ğ Ğ¥ Ğ¤ĞĞ¢Ğ: Ğ‘Ğ•Ğ— Ğ¢Ğ•ĞœĞĞĞ“Ğ Ğ“Ğ ĞĞ”Ğ˜Ğ•ĞĞ¢Ğ
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  Widget _buildOverlayMetricsRow(
    BuildContext context, {
    required Color textColor,
  }) {
    final stats = activity.stats;
    final activityTypeLower = activity.type.toLowerCase();
    final isSwim =
        activityTypeLower == 'swim' || activityTypeLower == 'swimming';
    final isBike =
        activityTypeLower == 'bike' ||
        activityTypeLower == 'bicycle' ||
        activityTypeLower == 'cycling' ||
        activityTypeLower == 'indoor-cycling';

    String formatSwimDistance(double meters) {
      final value = meters.toStringAsFixed(0);
      final buffer = StringBuffer();
      for (int i = 0; i < value.length; i++) {
        if (i > 0 && (value.length - i) % 3 == 0) {
          buffer.write(' ');
        }
        buffer.write(value[i]);
      }
      return buffer.toString();
    }

    final distanceText = stats?.distance != null
        ? isSwim
            ? '${formatSwimDistance(stats!.distance)} Ğ¼'
            : '${(stats!.distance / 1000.0).toStringAsFixed(2)} ĞºĞ¼'
        : 'â€”';

    final durationText = stats?.effectiveDuration != null
        ? formatDuration(stats!.effectiveDuration)
        : 'â€”';

    String paceText;
    double? speedKmh;

    if (isSwim) {
      if (stats?.avgPace != null && stats!.avgPace > 0) {
        paceText = formatPace(stats.avgPace / 10.0);
      } else if (stats?.distance != null &&
          stats?.effectiveDuration != null &&
          stats!.distance > 0 &&
          stats.effectiveDuration > 0) {
        final duration = stats.effectiveDuration.toDouble();
        final paceMinPer100m = (duration * 100) / (stats.distance * 60);
        paceText = formatPace(paceMinPer100m);
      } else {
        paceText = 'â€”';
      }
    } else {
      paceText = stats?.avgPace != null ? formatPace(stats!.avgPace) : 'â€”';
    }

    if (isBike) {
      if (activity.points.isEmpty &&
          stats?.distance != null &&
          stats?.effectiveDuration != null &&
          stats!.distance > 0 &&
          stats.effectiveDuration > 0) {
        final duration = stats.effectiveDuration.toDouble();
        speedKmh = (stats.distance / duration) * 3.6;
      } else if (stats?.avgSpeed != null && stats!.avgSpeed > 0) {
        speedKmh = stats.avgSpeed;
      } else if (stats?.distance != null &&
          stats?.effectiveDuration != null &&
          stats!.distance > 0 &&
          stats.effectiveDuration > 0) {
        final duration = stats.effectiveDuration.toDouble();
        speedKmh = (stats.distance / duration) * 3.6;
      }
    } else {
      if (stats?.distance != null &&
          stats?.effectiveDuration != null &&
          stats!.distance > 0 &&
          stats.effectiveDuration > 0) {
        final duration = stats.effectiveDuration.toDouble();
        speedKmh = (stats.distance / duration) * 3.6;
      }
    }

    final speedText = speedKmh != null
        ? '${speedKmh.toStringAsFixed(1)} ĞºĞ¼/Ñ‡'
        : 'â€”';

    return Row(
      mainAxisSize: MainAxisSize.max,
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        SizedBox(
          width: 130,
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              Text(
                'Ğ Ğ°ÑÑÑ‚Ğ¾ÑĞ½Ğ¸Ğµ',
                style: AppTextStyles.h11w4Sec.copyWith(
                  color: textColor,
                ),
              ),
              const SizedBox(height: 1),
              distanceText == 'â€”'
                  ? Text(
                      distanceText,
                      style: AppTextStyles.h17w6.copyWith(
                        color: textColor,
                      ),
                    )
                  : Text.rich(
                      TextSpan(
                        children: [
                          TextSpan(
                            text: distanceText
                                .replaceAll(' ĞºĞ¼', '')
                                .replaceAll(' Ğ¼', ''),
                            style: AppTextStyles.h17w6.copyWith(
                              color: textColor,
                            ),
                          ),
                          TextSpan(
                            text: distanceText.contains(' ĞºĞ¼') ? ' ĞºĞ¼' : ' Ğ¼',
                            style: AppTextStyles.h17w6.copyWith(
                              fontSize: 16,
                              color: textColor,
                            ),
                          ),
                        ],
                      ),
                    ),
            ],
          ),
        ),
        SizedBox(
          width: 110,
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              Text(
                'Ğ’Ñ€ĞµĞ¼Ñ, Ğ¼Ğ¸Ğ½',
                style: AppTextStyles.h11w4Sec.copyWith(
                  color: textColor,
                ),
              ),
              const SizedBox(height: 0),
              Text(
                durationText,
                style: AppTextStyles.h17w6.copyWith(
                  color: textColor,
                ),
              ),
            ],
          ),
        ),
        Expanded(
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              Text(
                isBike
                    ? 'Ğ¡ĞºĞ¾Ñ€Ğ¾ÑÑ‚ÑŒ'
                    : isSwim
                        ? 'Ğ¢ĞµĞ¼Ğ¿, /100Ğ¼'
                        : 'Ğ¢ĞµĞ¼Ğ¿, /ĞºĞ¼',
                style: AppTextStyles.h11w4Sec.copyWith(
                  color: textColor,
                ),
              ),
              const SizedBox(height: 0),
              isBike
                  ? (speedText == 'â€”'
                      ? Text(
                          speedText,
                          style: AppTextStyles.h17w6.copyWith(
                            color: textColor,
                          ),
                        )
                      : Text.rich(
                          TextSpan(
                            children: [
                              TextSpan(
                                text: speedText.replaceAll(' ĞºĞ¼/Ñ‡', ''),
                                style: AppTextStyles.h17w6.copyWith(
                                  color: textColor,
                                ),
                              ),
                              TextSpan(
                                text: ' ĞºĞ¼/Ñ‡',
                                style: AppTextStyles.h17w6.copyWith(
                                  fontSize: 16,
                                  color: textColor,
                                ),
                              ),
                            ],
                          ),
                        ))
                  : Text(
                      paceText,
                      style: AppTextStyles.h17w6.copyWith(
                        color: textColor,
                      ),
                    ),
            ],
          ),
        ),
      ],
    );
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // ğŸ”¹ ĞœĞ•Ğ¢Ğ Ğ˜ĞšĞ˜ Ğ’ ĞšĞĞ›ĞĞĞšĞ£: Ğ”Ğ›Ğ¯ Ğ¢Ğ Ğ•Ğ¢Ğ¬Ğ•Ğ“Ğ Ğ’Ğ˜Ğ”Ğ
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  Widget _buildOverlayMetricsColumn(
    BuildContext context, {
    bool isRightAligned = false,
    required Color textColor,
  }) {
    final textAlign = isRightAligned ? TextAlign.right : TextAlign.left;
    final itemCrossAxisAlignment = isRightAligned
        ? CrossAxisAlignment.end
        : CrossAxisAlignment.start;
    final itemAlignment = isRightAligned
        ? Alignment.centerRight
        : Alignment.centerLeft;
    final stats = activity.stats;
    final activityTypeLower = activity.type.toLowerCase();
    final isSwim =
        activityTypeLower == 'swim' || activityTypeLower == 'swimming';
    final isBike =
        activityTypeLower == 'bike' ||
        activityTypeLower == 'bicycle' ||
        activityTypeLower == 'cycling' ||
        activityTypeLower == 'indoor-cycling';

    String formatSwimDistance(double meters) {
      final value = meters.toStringAsFixed(0);
      final buffer = StringBuffer();
      for (int i = 0; i < value.length; i++) {
        if (i > 0 && (value.length - i) % 3 == 0) {
          buffer.write(' ');
        }
        buffer.write(value[i]);
      }
      return buffer.toString();
    }

    final distanceText = stats?.distance != null
        ? isSwim
            ? '${formatSwimDistance(stats!.distance)} Ğ¼'
            : '${(stats!.distance / 1000.0).toStringAsFixed(2)} ĞºĞ¼'
        : 'â€”';

    final durationText = stats?.effectiveDuration != null
        ? formatDuration(stats!.effectiveDuration)
        : 'â€”';

    String paceText;
    double? speedKmh;

    if (isSwim) {
      if (stats?.avgPace != null && stats!.avgPace > 0) {
        paceText = formatPace(stats.avgPace / 10.0);
      } else if (stats?.distance != null &&
          stats?.effectiveDuration != null &&
          stats!.distance > 0 &&
          stats.effectiveDuration > 0) {
        final duration = stats.effectiveDuration.toDouble();
        final paceMinPer100m = (duration * 100) / (stats.distance * 60);
        paceText = formatPace(paceMinPer100m);
      } else {
        paceText = 'â€”';
      }
    } else {
      paceText = stats?.avgPace != null ? formatPace(stats!.avgPace) : 'â€”';
    }

    if (isBike) {
      if (activity.points.isEmpty &&
          stats?.distance != null &&
          stats?.effectiveDuration != null &&
          stats!.distance > 0 &&
          stats.effectiveDuration > 0) {
        final duration = stats.effectiveDuration.toDouble();
        speedKmh = (stats.distance / duration) * 3.6;
      } else if (stats?.avgSpeed != null && stats!.avgSpeed > 0) {
        speedKmh = stats.avgSpeed;
      } else if (stats?.distance != null &&
          stats?.effectiveDuration != null &&
          stats!.distance > 0 &&
          stats.effectiveDuration > 0) {
        final duration = stats.effectiveDuration.toDouble();
        speedKmh = (stats.distance / duration) * 3.6;
      }
    } else {
      if (stats?.distance != null &&
          stats?.effectiveDuration != null &&
          stats!.distance > 0 &&
          stats.effectiveDuration > 0) {
        final duration = stats.effectiveDuration.toDouble();
        speedKmh = (stats.distance / duration) * 3.6;
      }
    }

    final speedText = speedKmh != null
        ? '${speedKmh.toStringAsFixed(1)} ĞºĞ¼/Ñ‡'
        : 'â€”';

    Widget buildMetricItem(String label, Widget value) {
      return Column(
        crossAxisAlignment: itemCrossAxisAlignment,
        children: [
          Text(
            label,
            style: AppTextStyles.h11w4Sec.copyWith(
              color: textColor,
            ),
            textAlign: textAlign,
          ),
          const SizedBox(height: 1),
          Align(
            alignment: itemAlignment,
            child: value,
          ),
        ],
      );
    }

    final distanceValue = distanceText == 'â€”'
        ? Text(
            distanceText,
            style: AppTextStyles.h17w6.copyWith(
              color: textColor,
            ),
            textAlign: textAlign,
          )
        : Text.rich(
            TextSpan(
              children: [
                TextSpan(
                  text: distanceText
                      .replaceAll(' ĞºĞ¼', '')
                      .replaceAll(' Ğ¼', ''),
                  style: AppTextStyles.h17w6.copyWith(
                    color: textColor,
                  ),
                ),
                TextSpan(
                  text: distanceText.contains(' ĞºĞ¼') ? ' ĞºĞ¼' : ' Ğ¼',
                  style: AppTextStyles.h17w6.copyWith(
                    fontSize: 16,
                    color: textColor,
                  ),
                ),
              ],
            ),
            textAlign: textAlign,
          );

    final durationValue = Text(
      durationText,
      style: AppTextStyles.h17w6.copyWith(
        color: textColor,
      ),
      textAlign: textAlign,
    );

    final paceValue = isBike
        ? (speedText == 'â€”'
            ? Text(
                speedText,
                style: AppTextStyles.h17w6.copyWith(
                  color: textColor,
                ),
                textAlign: textAlign,
              )
            : Text.rich(
                TextSpan(
                  children: [
                    TextSpan(
                      text: speedText.replaceAll(' ĞºĞ¼/Ñ‡', ''),
                      style: AppTextStyles.h17w6.copyWith(
                        color: textColor,
                      ),
                    ),
                    TextSpan(
                      text: ' ĞºĞ¼/Ñ‡',
                      style: AppTextStyles.h17w6.copyWith(
                        fontSize: 16,
                        color: textColor,
                      ),
                    ),
                  ],
                ),
                textAlign: textAlign,
              ))
        : Text(
            paceText,
            style: AppTextStyles.h17w6.copyWith(
              color: textColor,
            ),
            textAlign: textAlign,
          );

    return Column(
      crossAxisAlignment: itemCrossAxisAlignment,
      children: [
        buildMetricItem('Ğ Ğ°ÑÑÑ‚Ğ¾ÑĞ½Ğ¸Ğµ', distanceValue),
        const SizedBox(height: 12),
        buildMetricItem('Ğ’Ñ€ĞµĞ¼Ñ, Ğ¼Ğ¸Ğ½', durationValue),
        const SizedBox(height: 12),
        buildMetricItem(
          isBike
              ? 'Ğ¡ĞºĞ¾Ñ€Ğ¾ÑÑ‚ÑŒ'
              : isSwim
                  ? 'Ğ¢ĞµĞ¼Ğ¿, /100Ğ¼'
                  : 'Ğ¢ĞµĞ¼Ğ¿, /ĞºĞ¼',
          paceValue,
        ),
      ],
    );
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // ğŸ”¹ ĞœĞ•Ğ¢Ğ Ğ˜ĞšĞ˜ Ğ¡ Ğ¦Ğ•ĞĞ¢Ğ Ğ˜Ğ ĞĞ’ĞĞĞ˜Ğ•Ğœ Ğ”Ğ›Ğ¯ 5-Ğ“Ğ Ğ’Ğ˜Ğ”Ğ
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  Widget _buildOverlayMetricsColumnCentered(
    BuildContext context, {
    required Color textColor,
  }) {
    final stats = activity.stats;
    final activityTypeLower = activity.type.toLowerCase();
    final isSwim =
        activityTypeLower == 'swim' || activityTypeLower == 'swimming';
    final isBike =
        activityTypeLower == 'bike' ||
        activityTypeLower == 'bicycle' ||
        activityTypeLower == 'cycling' ||
        activityTypeLower == 'indoor-cycling';

    String formatSwimDistance(double meters) {
      final value = meters.toStringAsFixed(0);
      final buffer = StringBuffer();
      for (int i = 0; i < value.length; i++) {
        if (i > 0 && (value.length - i) % 3 == 0) {
          buffer.write(' ');
        }
        buffer.write(value[i]);
      }
      return buffer.toString();
    }

    final distanceText = stats?.distance != null
        ? isSwim
            ? '${formatSwimDistance(stats!.distance)} Ğ¼'
            : '${(stats!.distance / 1000.0).toStringAsFixed(2)} ĞºĞ¼'
        : 'â€”';

    final durationText = stats?.effectiveDuration != null
        ? formatDuration(stats!.effectiveDuration)
        : 'â€”';

    String paceText;
    double? speedKmh;

    if (isSwim) {
      if (stats?.avgPace != null && stats!.avgPace > 0) {
        paceText = formatPace(stats.avgPace / 10.0);
      } else if (stats?.distance != null &&
          stats?.effectiveDuration != null &&
          stats!.distance > 0 &&
          stats.effectiveDuration > 0) {
        final duration = stats.effectiveDuration.toDouble();
        final paceMinPer100m = (duration * 100) / (stats.distance * 60);
        paceText = formatPace(paceMinPer100m);
      } else {
        paceText = 'â€”';
      }
    } else {
      paceText = stats?.avgPace != null ? formatPace(stats!.avgPace) : 'â€”';
    }

    if (isBike) {
      if (activity.points.isEmpty &&
          stats?.distance != null &&
          stats?.effectiveDuration != null &&
          stats!.distance > 0 &&
          stats.effectiveDuration > 0) {
        final duration = stats.effectiveDuration.toDouble();
        speedKmh = (stats.distance / duration) * 3.6;
      } else if (stats?.avgSpeed != null && stats!.avgSpeed > 0) {
        speedKmh = stats.avgSpeed;
      } else if (stats?.distance != null &&
          stats?.effectiveDuration != null &&
          stats!.distance > 0 &&
          stats.effectiveDuration > 0) {
        final duration = stats.effectiveDuration.toDouble();
        speedKmh = (stats.distance / duration) * 3.6;
      }
    } else {
      if (stats?.distance != null &&
          stats?.effectiveDuration != null &&
          stats!.distance > 0 &&
          stats.effectiveDuration > 0) {
        final duration = stats.effectiveDuration.toDouble();
        speedKmh = (stats.distance / duration) * 3.6;
      }
    }

    final speedText = speedKmh != null
        ? '${speedKmh.toStringAsFixed(1)} ĞºĞ¼/Ñ‡'
        : 'â€”';

    Widget buildMetricItem(String label, Widget value) {
      return Column(
        crossAxisAlignment: CrossAxisAlignment.center,
        children: [
          Text(
            label,
            style: AppTextStyles.h13w4Sec.copyWith(
              fontWeight: FontWeight.w500,
              color: textColor,
            ),
            textAlign: TextAlign.center,
          ),
          const SizedBox(height: 0),
          Center(
            child: value,
          ),
        ],
      );
    }

    final distanceValue = distanceText == 'â€”'
        ? Text(
            distanceText,
            style: AppTextStyles.h18w6.copyWith(
              fontSize: 24,
              fontWeight: FontWeight.w700,
              color: textColor,
            ),
            textAlign: TextAlign.center,
          )
        : Text.rich(
            TextSpan(
              children: [
                TextSpan(
                  text: distanceText
                      .replaceAll(' ĞºĞ¼', '')
                      .replaceAll(' Ğ¼', ''),
                  style: AppTextStyles.h18w6.copyWith(
                    fontSize: 24,
                    fontWeight: FontWeight.w700,
                    color: textColor,
                  ),
                ),
                TextSpan(
                  text: distanceText.contains(' ĞºĞ¼') ? ' ĞºĞ¼' : ' Ğ¼',
                  style: AppTextStyles.h18w6.copyWith(
                    fontSize: 20,
                    fontWeight: FontWeight.w700,
                    color: textColor,
                  ),
                ),
              ],
            ),
            textAlign: TextAlign.center,
          );

    final durationValue = Text(
      durationText,
      style: AppTextStyles.h18w6.copyWith(
        fontSize: 24,
        fontWeight: FontWeight.w700,
        color: textColor,
      ),
      textAlign: TextAlign.center,
    );

    final paceValue = isBike
        ? (speedText == 'â€”'
            ? Text(
                speedText,
                style: AppTextStyles.h18w6.copyWith(
                  fontSize: 24,
                  fontWeight: FontWeight.w700,
                  color: textColor,
                ),
                textAlign: TextAlign.center,
              )
            : Text.rich(
                TextSpan(
                  children: [
                    TextSpan(
                      text: speedText.replaceAll(' ĞºĞ¼/Ñ‡', ''),
                      style: AppTextStyles.h18w6.copyWith(
                        fontSize: 24,
                        fontWeight: FontWeight.w700,
                        color: textColor,
                      ),
                    ),
                    TextSpan(
                      text: ' ĞºĞ¼/Ñ‡',
                      style: AppTextStyles.h18w6.copyWith(
                        fontSize: 20,
                        fontWeight: FontWeight.w700,
                        color: textColor,
                      ),
                    ),
                  ],
                ),
                textAlign: TextAlign.center,
              ))
        : Text(
            paceText,
            style: AppTextStyles.h18w6.copyWith(
              fontSize: 24,
              fontWeight: FontWeight.w700,
              color: textColor,
            ),
            textAlign: TextAlign.center,
          );

    return Column(
      crossAxisAlignment: CrossAxisAlignment.center,
      children: [
        buildMetricItem('Ğ Ğ°ÑÑÑ‚Ğ¾ÑĞ½Ğ¸Ğµ', distanceValue),
        const SizedBox(height: 12),
        buildMetricItem('Ğ’Ñ€ĞµĞ¼Ñ', durationValue),
        const SizedBox(height: 12),
        buildMetricItem(
          isBike
              ? 'Ğ¡ĞºĞ¾Ñ€Ğ¾ÑÑ‚ÑŒ'
              : isSwim
                  ? 'Ğ¢ĞµĞ¼Ğ¿, /100Ğ¼'
                  : 'Ğ¢ĞµĞ¼Ğ¿',
          paceValue,
        ),
      ],
    );
  }
}

/// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
/// ğŸ”¹ Ğ˜ĞĞ¢Ğ•Ğ ĞĞšĞ¢Ğ˜Ğ’ĞĞĞ¯ ĞšĞĞ Ğ¢Ğ Ğ”Ğ›Ğ¯ Ğ­ĞšĞ ĞĞĞ Ğ Ğ•ĞŸĞĞ¡Ğ¢Ğ (MAPBOX)
/// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
class _ShareRouteMap extends StatefulWidget {
  final List<LatLng> points;
  final ValueNotifier<Color> lineColorNotifier;
  final ValueNotifier<double> lineWidthNotifier;

  const _ShareRouteMap({
    required this.points,
    required this.lineColorNotifier,
    required this.lineWidthNotifier,
  });

  @override
  State<_ShareRouteMap> createState() => _ShareRouteMapState();
}

class _ShareRouteMapState extends State<_ShareRouteMap> {
  mapbox.PolylineAnnotationManager? _polylineAnnotationManager;
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // ğŸ”¹ Ğ¢Ğ•ĞšĞ£Ğ©ĞĞ¯ ĞŸĞĞ›Ğ˜Ğ›Ğ˜ĞĞ˜Ğ¯ Ğ”Ğ›Ğ¯ ĞĞ‘ĞĞĞ’Ğ›Ğ•ĞĞ˜Ğ¯ Ğ¦Ğ’Ğ•Ğ¢Ğ
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  mapbox.PolylineAnnotation? _polylineAnnotation;
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // ğŸ”¹ ĞĞ–Ğ˜Ğ”ĞĞ•ĞœĞ«Ğ™ Ğ¦Ğ’Ğ•Ğ¢, Ğ•Ğ¡Ğ›Ğ˜ ĞšĞĞ Ğ¢Ğ Ğ•Ğ©Ğ• ĞĞ• Ğ“ĞĞ¢ĞĞ’Ğ
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  Color? _pendingLineColor;
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // ğŸ”¹ Ğ¤Ğ›ĞĞ“ Ğ“ĞĞ¢ĞĞ’ĞĞĞ¡Ğ¢Ğ˜: ĞŸĞĞšĞĞ—Ğ«Ğ’ĞĞ•Ğœ ĞšĞĞ Ğ¢Ğ£ ĞŸĞĞ¡Ğ›Ğ• ĞĞ¢Ğ Ğ˜Ğ¡ĞĞ’ĞšĞ˜ Ğ¢Ğ Ğ•ĞšĞ
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  bool _isMapReady = false;

  @override
  void initState() {
    super.initState();
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // ğŸ”¹ Ğ¡Ğ›Ğ£Ğ¨ĞĞ•Ğœ Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ¯ Ğ¦Ğ’Ğ•Ğ¢Ğ Ğ˜ Ğ¢ĞĞ›Ğ©Ğ˜ĞĞ« Ğ”Ğ›Ğ¯ ĞŸĞĞ›Ğ˜Ğ›Ğ˜ĞĞ˜Ğ˜
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    widget.lineColorNotifier.addListener(_handleLineColorChanged);
    widget.lineWidthNotifier.addListener(_handleLineWidthChanged);
  }

  @override
  void didUpdateWidget(covariant _ShareRouteMap oldWidget) {
    super.didUpdateWidget(oldWidget);
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // ğŸ”¹ ĞŸĞ•Ğ Ğ•ĞŸĞĞ”ĞŸĞ˜Ğ¡ĞšĞ ĞŸĞ Ğ˜ Ğ¡ĞœĞ•ĞĞ• NOTIFIER
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    if (oldWidget.lineColorNotifier != widget.lineColorNotifier) {
      oldWidget.lineColorNotifier.removeListener(_handleLineColorChanged);
      widget.lineColorNotifier.addListener(_handleLineColorChanged);
      _scheduleLineColorUpdate(widget.lineColorNotifier.value);
    }
    if (oldWidget.lineWidthNotifier != widget.lineWidthNotifier) {
      oldWidget.lineWidthNotifier.removeListener(_handleLineWidthChanged);
      widget.lineWidthNotifier.addListener(_handleLineWidthChanged);
      _scheduleLineWidthUpdate(widget.lineWidthNotifier.value);
    }
  }

  @override
  void dispose() {
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // ğŸ”¹ ĞĞ¢ĞšĞ›Ğ®Ğ§ĞĞ•Ğœ Ğ›Ğ˜Ğ¡Ğ¢Ğ•ĞĞ•Ğ Ğ« Ğ˜ Ğ§Ğ˜Ğ¡Ğ¢Ğ˜Ğœ ĞœĞ•ĞĞ•Ğ”Ğ–Ğ•Ğ 
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    widget.lineColorNotifier.removeListener(_handleLineColorChanged);
    widget.lineWidthNotifier.removeListener(_handleLineWidthChanged);
    _polylineAnnotationManager?.deleteAll();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    final points = widget.points;

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // ğŸ”¹ ĞŸĞ£Ğ¡Ğ¢ĞĞ™ ĞœĞĞ Ğ¨Ğ Ğ£Ğ¢: Ğ‘Ğ•Ğ—ĞĞŸĞĞ¡ĞĞ«Ğ™ ĞŸĞ›Ğ•Ğ™Ğ¡Ğ¥ĞĞ›Ğ”Ğ•Ğ 
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    if (points.isEmpty) {
      return Container(
        color: AppColors.twinphoto,
        child: const Center(
          child: Icon(
            CupertinoIcons.map,
            size: 40,
            color: AppColors.scrim20,
          ),
        ),
      );
    }

    final bounds = _computeBounds(points);
    final center = LatLng(
      (bounds.minLat + bounds.maxLat) / 2,
      (bounds.minLng + bounds.maxLng) / 2,
    );

    return Stack(
      children: [
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // ğŸ”¹ Ğ¤ĞĞ: ĞŸĞĞšĞ ĞšĞĞ Ğ¢Ğ Ğ˜ĞĞ˜Ğ¦Ğ˜ĞĞ›Ğ˜Ğ—Ğ˜Ğ Ğ£Ğ•Ğ¢Ğ¡Ğ¯
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        Container(
          color: AppColors.twinphoto,
        ),
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // ğŸ”¹ MAPBOX-ĞšĞĞ Ğ¢Ğ: ĞŸĞĞ¯Ğ’Ğ›Ğ¯Ğ•Ğ¢Ğ¡Ğ¯ ĞŸĞĞ¡Ğ›Ğ• ĞĞ¢Ğ Ğ˜Ğ¡ĞĞ’ĞšĞ˜ Ğ¢Ğ Ğ•ĞšĞ
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        AnimatedOpacity(
          opacity: _isMapReady ? 1.0 : 0.0,
          duration: const Duration(milliseconds: 200),
          curve: Curves.easeInOut,
          child: mapbox.MapWidget(
            key: ValueKey('share_route_${points.length}'),
            onMapCreated: (mapboxMap) async {
              await _prepareMapbox(mapboxMap, points, bounds);
            },
            cameraOptions: mapbox.CameraOptions(
              center: mapbox.Point(
                coordinates: mapbox.Position(center.longitude, center.latitude),
              ),
              zoom: 12.0,
            ),
            styleUri: mapbox.MapboxStyles.MAPBOX_STREETS,
          ),
        ),
      ],
    );
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // ğŸ”¹ MAPBOX: ĞĞĞ”Ğ•Ğ–ĞĞĞ¯ Ğ˜ĞĞ˜Ğ¦Ğ˜ĞĞ›Ğ˜Ğ—ĞĞ¦Ğ˜Ğ¯ ĞšĞĞ Ğ¢Ğ« Ğ˜ ĞŸĞĞ›Ğ˜Ğ›Ğ˜ĞĞ˜Ğ˜
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  Future<void> _prepareMapbox(
    mapbox.MapboxMap mapboxMap,
    List<LatLng> points,
    _ShareRouteBounds bounds,
  ) async {
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // ğŸ”¹ ĞĞ¢ĞšĞ›Ğ®Ğ§ĞĞ•Ğœ SCALE BAR (Ğ”Ğ›Ğ¯ Ğ§Ğ˜Ğ¡Ğ¢ĞĞ“Ğ Ğ’Ğ˜Ğ”Ğ)
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    try {
      await mapboxMap.scaleBar.updateSettings(
        mapbox.ScaleBarSettings(enabled: false),
      );
    } catch (_) {
      // ĞĞ¸Ñ‡ĞµĞ³Ğ¾ Ğ½Ğµ Ğ´ĞµĞ»Ğ°ĞµĞ¼ â€” Ğ½Ğµ ĞºÑ€Ğ¸Ñ‚Ğ¸Ñ‡Ğ½Ğ¾
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // ğŸ”¹ Ğ”ĞĞ•Ğœ Ğ’Ğ Ğ•ĞœĞ¯ ĞĞ ĞŸĞĞ›ĞĞ£Ğ® Ğ˜ĞĞ˜Ğ¦Ğ˜ĞĞ›Ğ˜Ğ—ĞĞ¦Ğ˜Ğ® ĞšĞĞĞĞ›ĞĞ’
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    await Future.delayed(const Duration(milliseconds: 300));

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // ğŸ”¹ Ğ Ğ˜Ğ¡Ğ£Ğ•Ğœ ĞŸĞĞ›Ğ˜Ğ›Ğ˜ĞĞ˜Ğ® Ğ¡ ĞŸĞĞ’Ğ¢ĞĞ ĞĞ«ĞœĞ˜ ĞŸĞĞŸĞ«Ğ¢ĞšĞĞœĞ˜
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    await _drawTrackWithRetry(mapboxMap, points);
    _syncPendingLineColor();

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // ğŸ”¹ Ğ¤Ğ˜Ğ¢Ğ˜Ğœ ĞšĞĞœĞ•Ğ Ğ£ ĞŸĞ Ğ“Ğ ĞĞĞ˜Ğ¦ĞĞœ ĞœĞĞ Ğ¨Ğ Ğ£Ğ¢Ğ
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    await _fitCamera(mapboxMap, points, bounds);

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // ğŸ”¹ ĞŸĞĞšĞĞ—Ğ«Ğ’ĞĞ•Ğœ ĞšĞĞ Ğ¢Ğ£ ĞŸĞĞ¡Ğ›Ğ• Ğ˜ĞĞ˜Ğ¦Ğ˜ĞĞ›Ğ˜Ğ—ĞĞ¦Ğ˜Ğ˜
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    if (mounted) {
      setState(() {
        _isMapReady = true;
      });
    }
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // ğŸ”¹ Ğ Ğ˜Ğ¡Ğ£Ğ•Ğœ Ğ¢Ğ Ğ•Ğš Ğ¡ ĞŸĞĞ’Ğ¢ĞĞ ĞĞ«ĞœĞ˜ ĞŸĞĞŸĞ«Ğ¢ĞšĞĞœĞ˜
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  Future<void> _drawTrackWithRetry(
    mapbox.MapboxMap mapboxMap,
    List<LatLng> points,
  ) async {
    if (points.isEmpty) return;

    for (var attempt = 0; attempt < 3; attempt++) {
      try {
        _polylineAnnotationManager ??= await mapboxMap.annotations
            .createPolylineAnnotationManager();

        await _polylineAnnotationManager!.deleteAll();

        final coordinates = points
            .map((p) => mapbox.Position(p.longitude, p.latitude))
            .toList(growable: false);

    final lineColor = widget.lineColorNotifier.value.toARGB32();
    final lineWidth = widget.lineWidthNotifier.value;
        _polylineAnnotation = await _polylineAnnotationManager!.create(
          mapbox.PolylineAnnotationOptions(
            geometry: mapbox.LineString(coordinates: coordinates),
            lineColor: lineColor,
            lineWidth: lineWidth,
          ),
        );

        return;
      } catch (_) {
        await Future.delayed(const Duration(milliseconds: 200));
      }
    }
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // ğŸ”¹ Ğ›ĞĞšĞĞ›Ğ¬ĞĞĞ• ĞĞ‘ĞĞĞ’Ğ›Ğ•ĞĞ˜Ğ• Ğ¦Ğ’Ğ•Ğ¢Ğ ĞŸĞĞ›Ğ˜Ğ›Ğ˜ĞĞ˜Ğ˜
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  void _handleLineColorChanged() {
    _scheduleLineColorUpdate(widget.lineColorNotifier.value);
  }

  void _scheduleLineColorUpdate(Color color) {
    if (_polylineAnnotationManager == null || _polylineAnnotation == null) {
      _pendingLineColor = color;
      return;
    }
    _updatePolylineColor(color);
  }

  void _syncPendingLineColor() {
    if (_pendingLineColor == null) return;
    _updatePolylineColor(_pendingLineColor!);
    _pendingLineColor = null;
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // ğŸ”¹ Ğ›ĞĞšĞĞ›Ğ¬ĞĞĞ• ĞĞ‘ĞĞĞ’Ğ›Ğ•ĞĞ˜Ğ• Ğ¢ĞĞ›Ğ©Ğ˜ĞĞ« ĞŸĞĞ›Ğ˜Ğ›Ğ˜ĞĞ˜Ğ˜
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  void _handleLineWidthChanged() {
    _scheduleLineWidthUpdate(widget.lineWidthNotifier.value);
  }

  void _scheduleLineWidthUpdate(double width) {
    if (_polylineAnnotationManager == null || _polylineAnnotation == null) {
      return;
    }
    _updatePolylineWidth(width);
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // ğŸ”¹ ĞĞ‘ĞĞĞ’Ğ›Ğ¯Ğ•Ğœ Ğ¦Ğ’Ğ•Ğ¢: Ğ¡ĞĞĞ§ĞĞ›Ğ ĞŸĞ«Ğ¢ĞĞ•ĞœĞ¡Ğ¯ UPDATE, Ğ˜ĞĞĞ§Ğ• ĞŸĞ•Ğ Ğ•Ğ¡ĞĞ—Ğ”ĞĞ•Ğœ
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  Future<void> _updatePolylineColor(Color color) async {
    final manager = _polylineAnnotationManager;
    final annotation = _polylineAnnotation;
    if (manager == null || annotation == null) return;

    try {
      annotation.lineColor = color.toARGB32();
      await manager.update(annotation);
    } catch (_) {
      // Ğ•ÑĞ»Ğ¸ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ½Ğµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ â€” Ğ¿ĞµÑ€ĞµÑĞ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ğ¿Ğ¾Ğ»Ğ¸Ğ»Ğ¸Ğ½Ğ¸Ñ
      await _recreatePolyline();
    }
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // ğŸ”¹ ĞĞ‘ĞĞĞ’Ğ›Ğ¯Ğ•Ğœ Ğ¢ĞĞ›Ğ©Ğ˜ĞĞ£: ĞŸĞ•Ğ Ğ•Ğ¡ĞĞ—Ğ”ĞĞ•Ğœ ĞŸĞĞ›Ğ˜Ğ›Ğ˜ĞĞ˜Ğ®
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  Future<void> _updatePolylineWidth(double width) async {
    final manager = _polylineAnnotationManager;
    final annotation = _polylineAnnotation;
    if (manager == null || annotation == null) return;

    await _recreatePolyline();
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // ğŸ”¹ ĞŸĞ•Ğ Ğ•Ğ¡ĞĞ—Ğ”ĞĞĞ˜Ğ• ĞŸĞĞ›Ğ˜Ğ›Ğ˜ĞĞ˜Ğ˜ Ğ¡ Ğ¢Ğ•ĞšĞ£Ğ©Ğ˜ĞœĞ˜ ĞŸĞĞ ĞĞœĞ•Ğ¢Ğ ĞĞœĞ˜
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  Future<void> _recreatePolyline() async {
    final manager = _polylineAnnotationManager;
    final annotation = _polylineAnnotation;
    if (manager == null || annotation == null) return;

    try {
      await manager.deleteAll();
      _polylineAnnotation = await manager.create(
        mapbox.PolylineAnnotationOptions(
          geometry: annotation.geometry,
          lineColor: widget.lineColorNotifier.value.toARGB32(),
          lineWidth: widget.lineWidthNotifier.value,
        ),
      );
    } catch (_) {
      // Ğ˜Ğ³Ğ½Ğ¾Ñ€Ğ¸Ñ€ÑƒĞµĞ¼ Ğ¾ÑˆĞ¸Ğ±ĞºĞ¸ Ğ¿ĞµÑ€ĞµÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ñ
    }
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // ğŸ”¹ Ğ¤Ğ˜Ğ¢ ĞšĞĞœĞ•Ğ Ğ« ĞŸĞ Ğ“Ğ ĞĞĞ˜Ğ¦ĞĞœ
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  Future<void> _fitCamera(
    mapbox.MapboxMap mapboxMap,
    List<LatLng> points,
    _ShareRouteBounds bounds,
  ) async {
    try {
      if (points.length == 1) {
        await mapboxMap.setCamera(
          mapbox.CameraOptions(
            center: mapbox.Point(
              coordinates: mapbox.Position(
                points.first.longitude,
                points.first.latitude,
              ),
            ),
            zoom: 14.0,
          ),
        );
      } else {
        final camera = await mapboxMap.cameraForCoordinateBounds(
          mapbox.CoordinateBounds(
            southwest: mapbox.Point(
              coordinates: mapbox.Position(
                bounds.minLng,
                bounds.minLat,
              ),
            ),
            northeast: mapbox.Point(
              coordinates: mapbox.Position(
                bounds.maxLng,
                bounds.maxLat,
              ),
            ),
            infiniteBounds: false,
          ),
          mapbox.MbxEdgeInsets(
            top: 16,
            left: 16,
            right: 16,
            bottom: 16,
          ),
          null,
          null,
          null,
          null,
        );
        await mapboxMap.setCamera(camera);
      }
    } catch (_) {
      // Ğ•ÑĞ»Ğ¸ ĞºĞ°Ğ¼ĞµÑ€Ğ° Ğ½Ğµ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ğ»Ğ°ÑÑŒ â€” Ğ¾ÑÑ‚Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ´ĞµÑ„Ğ¾Ğ»Ñ‚Ğ½ÑƒÑ Ğ¿Ğ¾Ğ·Ğ¸Ñ†Ğ¸Ñ
    }
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // ğŸ”¹ Ğ¥Ğ•Ğ›ĞŸĞ•Ğ : Ğ ĞĞ¡Ğ§Ğ•Ğ¢ Ğ“Ğ ĞĞĞ˜Ğ¦ Ğ”Ğ›Ğ¯ Ğ¤Ğ˜Ğ¢Ğ ĞšĞĞœĞ•Ğ Ğ«
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  _ShareRouteBounds _computeBounds(List<LatLng> points) {
    var minLat = points.first.latitude;
    var maxLat = points.first.latitude;
    var minLng = points.first.longitude;
    var maxLng = points.first.longitude;

    for (final point in points.skip(1)) {
      if (point.latitude < minLat) minLat = point.latitude;
      if (point.latitude > maxLat) maxLat = point.latitude;
      if (point.longitude < minLng) minLng = point.longitude;
      if (point.longitude > maxLng) maxLng = point.longitude;
    }

    return _ShareRouteBounds(
      minLat: minLat,
      maxLat: maxLat,
      minLng: minLng,
      maxLng: maxLng,
    );
  }
}

/// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
/// ğŸ”¹ Ğ“Ğ ĞĞĞ˜Ğ¦Ğ« ĞœĞĞ Ğ¨Ğ Ğ£Ğ¢Ğ Ğ”Ğ›Ğ¯ Ğ¤Ğ˜Ğ¢Ğ ĞšĞĞœĞ•Ğ Ğ«
/// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
class _ShareRouteBounds {
  final double minLat;
  final double maxLat;
  final double minLng;
  final double maxLng;

  const _ShareRouteBounds({
    required this.minLat,
    required this.maxLat,
    required this.minLng,
    required this.maxLng,
  });
}

/// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
/// ğŸ”¹ ĞŸĞ Ğ•Ğ’Ğ¬Ğ® ĞœĞĞ Ğ¨Ğ Ğ£Ğ¢Ğ Ğ’ ĞšĞ’ĞĞ”Ğ ĞĞ¢Ğ• (Ğ”Ğ›Ğ¯ ĞŸĞ ĞĞ—Ğ ĞĞ§ĞĞĞ“Ğ Ğ¤ĞĞĞ)
/// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
class _MiniRoutePainter extends CustomPainter {
  final List<LatLng> points;
  final Color lineColor;
  final double lineWidth;

  const _MiniRoutePainter({
    required this.points,
    required this.lineColor,
    required this.lineWidth,
  });

  @override
  void paint(Canvas canvas, Size size) {
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // ğŸ”¹ Ğ—ĞĞ©Ğ˜Ğ¢Ğ: ĞĞ• Ğ Ğ˜Ğ¡Ğ£Ğ•Ğœ ĞŸĞ£Ğ¡Ğ¢ĞĞ™ ĞœĞĞ Ğ¨Ğ Ğ£Ğ¢
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    if (points.isEmpty) return;

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // ğŸ”¹ Ğ’Ğ«Ğ§Ğ˜Ğ¡Ğ›Ğ¯Ğ•Ğœ Ğ“Ğ ĞĞĞ˜Ğ¦Ğ« ĞœĞĞ Ğ¨Ğ Ğ£Ğ¢Ğ
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    var minLat = points.first.latitude;
    var maxLat = points.first.latitude;
    var minLng = points.first.longitude;
    var maxLng = points.first.longitude;

    for (final point in points.skip(1)) {
      if (point.latitude < minLat) minLat = point.latitude;
      if (point.latitude > maxLat) maxLat = point.latitude;
      if (point.longitude < minLng) minLng = point.longitude;
      if (point.longitude > maxLng) maxLng = point.longitude;
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // ğŸ”¹ Ğ—ĞĞ”ĞĞ•Ğœ Ğ’ĞĞ£Ğ¢Ğ Ğ•ĞĞĞ˜Ğ™ ĞĞ¢Ğ¡Ğ¢Ğ£ĞŸ Ğ”Ğ›Ğ¯ Ğ’Ğ˜Ğ—Ğ£ĞĞ›Ğ¬ĞĞĞ“Ğ Ğ’ĞĞ—Ğ”Ğ£Ğ¥Ğ
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const padding = 3.0;
    final usableWidth = (size.width - padding * 2).clamp(0.0, size.width);
    final usableHeight = (size.height - padding * 2).clamp(0.0, size.height);

    final rangeLng = (maxLng - minLng).abs();
    final rangeLat = (maxLat - minLat).abs();
    final safeRangeLng = rangeLng < 1e-9 ? 1.0 : rangeLng;
    final safeRangeLat = rangeLat < 1e-9 ? 1.0 : rangeLat;

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // ğŸ”¹ Ğ¡Ğ¢Ğ ĞĞ˜Ğœ PATH ĞœĞĞ Ğ¨Ğ Ğ£Ğ¢Ğ Ğ’ ĞŸĞ Ğ•Ğ”Ğ•Ğ›ĞĞ¥ ĞšĞ’ĞĞ”Ğ ĞĞ¢Ğ
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    final path = ui.Path();
    for (var i = 0; i < points.length; i++) {
      final point = points[i];
      final tX = (point.longitude - minLng) / safeRangeLng;
      final tY = 1.0 - (point.latitude - minLat) / safeRangeLat;

      final x = padding + tX * usableWidth;
      final y = padding + tY * usableHeight;

      if (i == 0) {
        path.moveTo(x, y);
      } else {
        path.lineTo(x, y);
      }
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // ğŸ”¹ ĞŸĞĞ”Ğ‘Ğ˜Ğ ĞĞ•Ğœ Ğ¢ĞĞ›Ğ©Ğ˜ĞĞ£ Ğ›Ğ˜ĞĞ˜Ğ˜ Ğ”Ğ›Ğ¯ ĞœĞĞ›ĞĞ“Ğ Ğ ĞĞ—ĞœĞ•Ğ Ğ
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    final effectiveLineWidth = (lineWidth * 0.6).clamp(1.0, 3.0);

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // ğŸ”¹ Ğ Ğ˜Ğ¡Ğ£Ğ•Ğœ Ğ›Ğ˜ĞĞ˜Ğ® ĞœĞĞ Ğ¨Ğ Ğ£Ğ¢Ğ
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    final paint = Paint()
      ..color = lineColor
      ..strokeWidth = effectiveLineWidth
      ..style = PaintingStyle.stroke
      ..strokeCap = StrokeCap.round
      ..strokeJoin = StrokeJoin.round;
    canvas.drawPath(path, paint);
  }

  @override
  bool shouldRepaint(covariant _MiniRoutePainter oldDelegate) {
    return oldDelegate.points != points ||
        oldDelegate.lineColor != lineColor ||
        oldDelegate.lineWidth != lineWidth;
  }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ğŸ”¹ Ğ¥Ğ•Ğ›ĞŸĞ•Ğ : Ğ¤ĞĞ ĞœĞ˜Ğ Ğ£Ğ•Ğœ Ğ¡ĞŸĞ˜Ğ¡ĞĞš ĞœĞ•Ğ”Ğ˜Ğ Ğ¡ Ğ£Ğ§Ğ•Ğ¢ĞĞœ Ğ¡ĞĞ Ğ¢Ğ˜Ğ ĞĞ’ĞšĞ˜ ĞšĞĞ Ğ¢Ğ«
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
List<ShareMediaItem> _buildMediaItems(Activity activity) {
  final items = <ShareMediaItem>[];

  for (final imageUrl in activity.mediaImages) {
    items.add(ShareMediaItem.photo(imageUrl));
  }

  if (activity.points.isNotEmpty) {
    final mapInsertIndex =
        (activity.mapSortOrder ?? items.length).clamp(0, items.length);
    items.insert(mapInsertIndex, const ShareMediaItem.map());
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // ğŸ”¹ Ğ”ĞĞ‘ĞĞ’Ğ›Ğ¯Ğ•Ğœ ĞĞ¡Ğ¡Ğ•Ğ¢ opacity.jpg Ğ’ ĞšĞĞĞ•Ğ¦ Ğ¡ĞŸĞ˜Ğ¡ĞšĞ
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  items.add(const ShareMediaItem.asset('assets/opacity.jpg'));

  return items;
}
