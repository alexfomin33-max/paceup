// lib/core/utils/polyline_simplifier.dart
import 'dart:math' as math;
import 'package:latlong2/latlong.dart';

/// –£—Ç–∏–ª–∏—Ç–∞ –¥–ª—è —É–ø—Ä–æ—â–µ–Ω–∏—è –ø–æ–ª–∏–ª–∏–Ω–∏–π —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –∞–ª–≥–æ—Ä–∏—Ç–º–∞ –î—É–≥–ª–∞—Å–∞-–ü–µ–∫–µ—Ä–∞.
///
/// –ê–ª–≥–æ—Ä–∏—Ç–º –î—É–≥–ª–∞—Å–∞-–ü–µ–∫–µ—Ä–∞ —Ä–µ–∫—É—Ä—Å–∏–≤–Ω–æ —É–¥–∞–ª—è–µ—Ç —Ç–æ—á–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ –Ω–∞—Ö–æ–¥—è—Ç—Å—è
/// –±–ª–∏–∑–∫–æ –∫ –ø—Ä—è–º–æ–π –ª–∏–Ω–∏–∏ –º–µ–∂–¥—É –¥–≤—É–º—è —Å–æ—Å–µ–¥–Ω–∏–º–∏ —Ç–æ—á–∫–∞–º–∏, —Å–æ—Ö—Ä–∞–Ω—è—è –ø—Ä–∏ —ç—Ç–æ–º
/// –≤–∞–∂–Ω—ã–µ –ø–æ–≤–æ—Ä–æ—Ç—ã –∏ –∏–∑–≥–∏–±—ã –º–∞—Ä—à—Ä—É—Ç–∞.
///
/// ‚ö° PERFORMANCE OPTIMIZATION:
/// - –£–º–µ–Ω—å—à–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ—á–µ–∫ –≤ 5-20 —Ä–∞–∑ –¥–ª—è –±–æ–ª—å—à–∏—Ö –º–∞—Ä—à—Ä—É—Ç–æ–≤
/// - –ó–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ —É—Å–∫–æ—Ä—è–µ—Ç —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥ –∫–∞—Ä—Ç—ã
/// - –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤–∏–∑—É–∞–ª—å–Ω—É—é —Ñ–æ—Ä–º—É –º–∞—Ä—à—Ä—É—Ç–∞
///
/// –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:
/// ```dart
/// final simplified = PolylineSimplifier.simplify(
///   points: originalPoints,
///   tolerance: 5.0, // –º–µ—Ç—Ä—ã
/// );
/// ```
class PolylineSimplifier {
  /// –£–ø—Ä–æ—â–∞–µ—Ç –ø–æ–ª–∏–ª–∏–Ω–∏—é —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –∞–ª–≥–æ—Ä–∏—Ç–º–∞ –î—É–≥–ª–∞—Å–∞-–ü–µ–∫–µ—Ä–∞.
  ///
  /// –ü–∞—Ä–∞–º–µ—Ç—Ä—ã:
  /// - [points] - –∏—Å—Ö–æ–¥–Ω—ã–π —Å–ø–∏—Å–æ–∫ —Ç–æ—á–µ–∫ –º–∞—Ä—à—Ä—É—Ç–∞
  /// - [tolerance] - –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –≤ –º–µ—Ç—Ä–∞—Ö, –Ω–∞ –∫–æ—Ç–æ—Ä–æ–µ —Ç–æ—á–∫–∞
  ///   –º–æ–∂–µ—Ç –æ—Ç–∫–ª–æ–Ω—è—Ç—å—Å—è –æ—Ç –ø—Ä—è–º–æ–π –ª–∏–Ω–∏–∏ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 5 –º–µ—Ç—Ä–æ–≤)
  /// - [maxPoints] - –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ—á–µ–∫ –ø–æ—Å–ª–µ —É–ø—Ä–æ—â–µ–Ω–∏—è
  ///   (–µ—Å–ª–∏ null, –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –Ω–µ—Ç)
  ///
  /// –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —É–ø—Ä–æ—â–µ–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ —Ç–æ—á–µ–∫, —Å–æ—Ö—Ä–∞–Ω—è—è –ø–µ—Ä–≤—É—é –∏ –ø–æ—Å–ª–µ–¥–Ω—é—é —Ç–æ—á–∫–∏.
  ///
  /// ‚ö° PERFORMANCE:
  /// - –î–ª—è –º–∞—Ä—à—Ä—É—Ç–æ–≤ < 100 —Ç–æ—á–µ–∫ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∏—Å—Ö–æ–¥–Ω—ã–π —Å–ø–∏—Å–æ–∫ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
  /// - –î–ª—è –º–∞—Ä—à—Ä—É—Ç–æ–≤ 100-500 —Ç–æ—á–µ–∫ –ø—Ä–∏–º–µ–Ω—è–µ—Ç —É–ø—Ä–æ—â–µ–Ω–∏–µ —Å tolerance
  /// - –î–ª—è –º–∞—Ä—à—Ä—É—Ç–æ–≤ > 500 —Ç–æ—á–µ–∫ –ø—Ä–∏–º–µ–Ω—è–µ—Ç –∞–≥—Ä–µ—Å—Å–∏–≤–Ω–æ–µ —É–ø—Ä–æ—â–µ–Ω–∏–µ
  static List<LatLng> simplify({
    required List<LatLng> points,
    double tolerance = 5.0,
    int? maxPoints,
  }) {
    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // üîπ –ó–ê–©–ò–¢–ê: –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º edge cases
    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    if (points.isEmpty) return points;
    if (points.length <= 2) return List.from(points);

    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // üîπ –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–Ø: –¥–ª—è –º–∞–ª–µ–Ω—å–∫–∏—Ö –º–∞—Ä—à—Ä—É—Ç–æ–≤ –Ω–µ —É–ø—Ä–æ—â–∞–µ–º
    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // –î–ª—è –º–∞—Ä—à—Ä—É—Ç–æ–≤ < 100 —Ç–æ—á–µ–∫ —É–ø—Ä–æ—â–µ–Ω–∏–µ –Ω–µ –¥–∞—Å—Ç –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ–≥–æ —ç—Ñ—Ñ–µ–∫—Ç–∞,
    // –Ω–æ –º–æ–∂–µ—Ç —É—Ö—É–¥—à–∏—Ç—å –∫–∞—á–µ—Å—Ç–≤–æ
    if (points.length < 100) {
      return List.from(points);
    }

    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // üîπ –ê–î–ê–ü–¢–ò–í–ù–´–ô –ü–û–†–û–ì: —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º tolerance –¥–ª—è –±–æ–ª—å—à–∏—Ö –º–∞—Ä—à—Ä—É—Ç–æ–≤
    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // –î–ª—è –º–∞—Ä—à—Ä—É—Ç–æ–≤ > 1000 —Ç–æ—á–µ–∫ –∏—Å–ø–æ–ª—å–∑—É–µ–º –±–æ–ª–µ–µ –∞–≥—Ä–µ—Å—Å–∏–≤–Ω–æ–µ —É–ø—Ä–æ—â–µ–Ω–∏–µ
    double adaptiveTolerance = tolerance;
    if (points.length > 1000) {
      // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º tolerance –ø—Ä–æ–ø–æ—Ä—Ü–∏–æ–Ω–∞–ª—å–Ω–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É —Ç–æ—á–µ–∫
      // –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ü–µ–ª–µ–≤–æ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Ç–æ—á–µ–∫ ~200-300
      adaptiveTolerance = tolerance * (points.length / 500).clamp(1.0, 3.0);
    }

    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // üîπ –ü–†–ò–ú–ï–ù–Ø–ï–ú –ê–õ–ì–û–†–ò–¢–ú –î–£–ì–õ–ê–°–ê-–ü–ï–ö–ï–†–ê
    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    final simplified = _douglasPeucker(
      points: points,
      tolerance: adaptiveTolerance,
    );

    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // üîπ –û–ì–†–ê–ù–ò–ß–ï–ù–ò–ï –ö–û–õ–ò–ß–ï–°–¢–í–ê –¢–û–ß–ï–ö: –µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω maxPoints
    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    if (maxPoints != null && simplified.length > maxPoints) {
      return _reduceToMaxPoints(simplified, maxPoints);
    }

    return simplified;
  }

  /// –†–µ–∫—É—Ä—Å–∏–≤–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –∞–ª–≥–æ—Ä–∏—Ç–º–∞ –î—É–≥–ª–∞—Å–∞-–ü–µ–∫–µ—Ä–∞.
  ///
  /// –ê–ª–≥–æ—Ä–∏—Ç–º:
  /// 1. –ù–∞—Ö–æ–¥–∏–º —Ç–æ—á–∫—É, –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ —É–¥–∞–ª–µ–Ω–Ω—É—é –æ—Ç –ø—Ä—è–º–æ–π –º–µ–∂–¥—É –ø–µ—Ä–≤–æ–π –∏ –ø–æ—Å–ª–µ–¥–Ω–µ–π —Ç–æ—á–∫–æ–π
  /// 2. –ï—Å–ª–∏ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –±–æ–ª—å—à–µ tolerance - —Ä–µ–∫—É—Ä—Å–∏–≤–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –æ–±–µ —á–∞—Å—Ç–∏
  /// 3. –ï—Å–ª–∏ –º–µ–Ω—å—à–µ - —É–¥–∞–ª—è–µ–º –≤—Å–µ –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–µ —Ç–æ—á–∫–∏
  static List<LatLng> _douglasPeucker({
    required List<LatLng> points,
    required double tolerance,
  }) {
    // –ë–∞–∑–æ–≤—ã–π —Å–ª—É—á–∞–π: –µ—Å–ª–∏ —Ç–æ—á–µ–∫ <= 2, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–∞–∫ –µ—Å—Ç—å
    if (points.length <= 2) {
      return List.from(points);
    }

    final first = points.first;
    final last = points.last;

    // –ù–∞—Ö–æ–¥–∏–º —Ç–æ—á–∫—É —Å –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–º –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ–º –æ—Ç –ø—Ä—è–º–æ–π
    double maxDistance = 0.0;
    int maxIndex = 0;

    for (int i = 1; i < points.length - 1; i++) {
      final distance = _perpendicularDistance(
        point: points[i],
        lineStart: first,
        lineEnd: last,
      );

      if (distance > maxDistance) {
        maxDistance = distance;
        maxIndex = i;
      }
    }

    // –ï—Å–ª–∏ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ –º–µ–Ω—å—à–µ tolerance, —É–¥–∞–ª—è–µ–º –≤—Å–µ –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–µ —Ç–æ—á–∫–∏
    if (maxDistance < tolerance) {
      return [first, last];
    }

    // –†–µ–∫—É—Ä—Å–∏–≤–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –ª–µ–≤—É—é –∏ –ø—Ä–∞–≤—É—é —á–∞—Å—Ç–∏
    final leftPart = _douglasPeucker(
      points: points.sublist(0, maxIndex + 1),
      tolerance: tolerance,
    );

    final rightPart = _douglasPeucker(
      points: points.sublist(maxIndex),
      tolerance: tolerance,
    );

    // –û–±—ä–µ–¥–∏–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã, —É–±–∏—Ä–∞—è –¥—É–±–ª–∏–∫–∞—Ç –≤ —Ç–æ—á–∫–µ maxIndex
    return [
      ...leftPart,
      ...rightPart.skip(1), // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –ø–µ—Ä–≤—É—é —Ç–æ—á–∫—É (–æ–Ω–∞ —É–∂–µ –µ—Å—Ç—å –≤ leftPart)
    ];
  }

  /// –í—ã—á–∏—Å–ª—è–µ—Ç –ø–µ—Ä–ø–µ–Ω–¥–∏–∫—É–ª—è—Ä–Ω–æ–µ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –æ—Ç —Ç–æ—á–∫–∏ –¥–æ –ø—Ä—è–º–æ–π –ª–∏–Ω–∏–∏
  /// –Ω–∞ —Å—Ñ–µ—Ä–µ (–≥–µ–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã).
  ///
  /// –ò—Å–ø–æ–ª—å–∑—É–µ—Ç —É–ø—Ä–æ—â–µ–Ω–Ω—É—é —Ñ–æ—Ä–º—É–ª—É –¥–ª—è –º–∞–ª—ã—Ö —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–π (–¥–æ ~1000 –∫–º),
  /// —á—Ç–æ –ø–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è –º–∞—Ä—à—Ä—É—Ç–æ–≤ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫.
  ///
  /// ‚ö° PERFORMANCE:
  /// - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –ø—Ä–∏–±–ª–∏–∂–µ–Ω–Ω—É—é —Ñ–æ—Ä–º—É–ª—É –¥–ª—è —Å–∫–æ—Ä–æ—Å—Ç–∏
  /// - –¢–æ—á–Ω–æ—Å—Ç—å –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–∞ –¥–ª—è —É–ø—Ä–æ—â–µ–Ω–∏—è –º–∞—Ä—à—Ä—É—Ç–æ–≤
  static double _perpendicularDistance({
    required LatLng point,
    required LatLng lineStart,
    required LatLng lineEnd,
  }) {
    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // üîπ –£–ü–†–û–©–ï–ù–ù–ê–Ø –§–û–†–ú–£–õ–ê: –¥–ª—è –º–∞–ª—ã—Ö —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–π –∏—Å–ø–æ–ª—å–∑—É–µ–º
    // –ø—Ä–æ–µ–∫—Ü–∏—é –Ω–∞ –ø–ª–æ—Å–∫–æ—Å—Ç—å (–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ç–æ—á–Ω–æ –¥–ª—è –º–∞—Ä—à—Ä—É—Ç–æ–≤)
    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

    // –í—ã—á–∏—Å–ª—è–µ–º –≤–µ–∫—Ç–æ—Ä—ã
    final dx = lineEnd.longitude - lineStart.longitude;
    final dy = lineEnd.latitude - lineStart.latitude;

    // –ï—Å–ª–∏ –ª–∏–Ω–∏—è –≤—ã—Ä–æ–∂–¥–µ–Ω–∞ (–Ω–∞—á–∞–ª–æ = –∫–æ–Ω–µ—Ü), –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –¥–æ —Ç–æ—á–∫–∏
    if (dx == 0 && dy == 0) {
      return _haversineDistance(lineStart, point);
    }

    // –í—ã—á–∏—Å–ª—è–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä t –¥–ª—è –ø—Ä–æ–µ–∫—Ü–∏–∏ —Ç–æ—á–∫–∏ –Ω–∞ –ø—Ä—è–º—É—é
    final t = ((point.longitude - lineStart.longitude) * dx +
            (point.latitude - lineStart.latitude) * dy) /
        (dx * dx + dy * dy);

    // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º t –≤ –¥–∏–∞–ø–∞–∑–æ–Ω–µ [0, 1] –¥–ª—è –ø—Ä–æ–µ–∫—Ü–∏–∏ –Ω–∞ —Å–µ–≥–º–µ–Ω—Ç
    final clampedT = t.clamp(0.0, 1.0);

    // –í—ã—á–∏—Å–ª—è–µ–º –ø—Ä–æ–µ–∫—Ü–∏—é —Ç–æ—á–∫–∏ –Ω–∞ –ø—Ä—è–º—É—é
    final projectedLng = lineStart.longitude + clampedT * dx;
    final projectedLat = lineStart.latitude + clampedT * dy;
    final projected = LatLng(projectedLat, projectedLng);

    // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –æ—Ç —Ç–æ—á–∫–∏ –¥–æ –ø—Ä–æ–µ–∫—Ü–∏–∏ (–≤ –º–µ—Ç—Ä–∞—Ö)
    return _haversineDistance(point, projected);
  }

  /// –í—ã—á–∏—Å–ª—è–µ—Ç —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –º–µ–∂–¥—É –¥–≤—É–º—è —Ç–æ—á–∫–∞–º–∏ –Ω–∞ —Å—Ñ–µ—Ä–µ –ø–æ —Ñ–æ—Ä–º—É–ª–µ Haversine.
  ///
  /// –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –≤ –º–µ—Ç—Ä–∞—Ö.
  ///
  /// ‚ö° PERFORMANCE:
  /// - –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Ñ–æ—Ä–º—É–ª–∞ Haversine
  /// - –¢–æ—á–Ω–æ—Å—Ç—å –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–∞ –¥–ª—è –º–∞—Ä—à—Ä—É—Ç–æ–≤ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫
  static double _haversineDistance(LatLng point1, LatLng point2) {
    const double earthRadiusMeters = 6371000.0; // –†–∞–¥–∏—É—Å –ó–µ–º–ª–∏ –≤ –º–µ—Ç—Ä–∞—Ö

    final lat1Rad = point1.latitude * (3.141592653589793 / 180.0);
    final lat2Rad = point2.latitude * (3.141592653589793 / 180.0);
    final deltaLatRad = (point2.latitude - point1.latitude) *
        (3.141592653589793 / 180.0);
    final deltaLngRad = (point2.longitude - point1.longitude) *
        (3.141592653589793 / 180.0);

    final a = math.sin(deltaLatRad / 2) * math.sin(deltaLatRad / 2) +
        math.cos(lat1Rad) *
            math.cos(lat2Rad) *
            math.sin(deltaLngRad / 2) *
            math.sin(deltaLngRad / 2);
    final c = 2 * math.asin(math.sqrt(a));

    return earthRadiusMeters * c;
  }

  /// –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ —É–º–µ–Ω—å—à–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ—á–µ–∫ –¥–æ maxPoints,
  /// —Ä–∞–≤–Ω–æ–º–µ—Ä–Ω–æ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è—è —Ç–æ—á–∫–∏ –ø–æ –º–∞—Ä—à—Ä—É—Ç—É.
  ///
  /// –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è, –∫–æ–≥–¥–∞ –∞–ª–≥–æ—Ä–∏—Ç–º –î—É–≥–ª–∞—Å–∞-–ü–µ–∫–µ—Ä–∞ –Ω–µ —Å–º–æ–≥
  /// –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —É–ø—Ä–æ—Å—Ç–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç.
  static List<LatLng> _reduceToMaxPoints(
    List<LatLng> points,
    int maxPoints,
  ) {
    if (points.length <= maxPoints) {
      return points;
    }

    // –í—Å–µ–≥–¥–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –ø–µ—Ä–≤—É—é –∏ –ø–æ—Å–ª–µ–¥–Ω—é—é —Ç–æ—á–∫–∏
    if (maxPoints < 2) {
      return [points.first, points.last];
    }

    final result = <LatLng>[points.first];
    final step = (points.length - 1) / (maxPoints - 1);

    for (int i = 1; i < maxPoints - 1; i++) {
      final index = (i * step).round();
      result.add(points[index.clamp(0, points.length - 1)]);
    }

    result.add(points.last);
    return result;
  }
}


