// lib/core/utils/static_map_url_builder.dart
import 'package:latlong2/latlong.dart';
import 'package:flutter/material.dart';
import '../config/app_config.dart';
import '../theme/app_theme.dart';
import 'polyline_simplifier.dart';

/// –£—Ç–∏–ª–∏—Ç–∞ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ URL —Å—Ç–∞—Ç–∏—á–Ω—ã—Ö –∫–∞—Ä—Ç Mapbox Static Images API.
///
/// –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Å—Ç–∞—Ç–∏—á–Ω—ã—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –º–∞—Ä—à—Ä—É—Ç–æ–≤ –≤–º–µ—Å—Ç–æ
/// –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–∞—Ä—Ç Mapbox GL, —á—Ç–æ —É—Å—Ç—Ä–∞–Ω—è–µ—Ç jank –ø—Ä–∏ —Å–∫—Ä–æ–ª–ª–µ –≤ –ª–µ–Ω—Ç–µ.
///
/// ‚ö° PERFORMANCE OPTIMIZATION:
/// - –°—Ç–∞—Ç–∏—á–Ω—ã–µ PNG –∫–∞—Ä—Ç–∏–Ω–∫–∏ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –±—ã—Å—Ç—Ä–µ–µ, —á–µ–º GL-–ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç–∏
/// - –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ CachedNetworkImage —Å–Ω–∏–∂–∞–µ—Ç –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã
/// - –£–ø—Ä–æ—â–µ–Ω–∏–µ –ø–æ–ª–∏–ª–∏–Ω–∏–∏ —É–º–µ–Ω—å—à–∞–µ—Ç —Ä–∞–∑–º–µ—Ä URL –∏ —É—Å–∫–æ—Ä—è–µ—Ç –≥–µ–Ω–µ—Ä–∞—Ü–∏—é
class StaticMapUrlBuilder {
  /// –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç URL –¥–ª—è —Å—Ç–∞—Ç–∏—á–Ω–æ–π –∫–∞—Ä—Ç—ã Mapbox —Å –º–∞—Ä—à—Ä—É—Ç–æ–º.
  ///
  /// –ü–∞—Ä–∞–º–µ—Ç—Ä—ã:
  /// - [points] - —Å–ø–∏—Å–æ–∫ —Ç–æ—á–µ–∫ –º–∞—Ä—à—Ä—É—Ç–∞ (–±—É–¥–µ—Ç —É–ø—Ä–æ—â—ë–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)
  /// - [widthPx] - —à–∏—Ä–∏–Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ –ø–∏–∫—Å–µ–ª—è—Ö
  /// - [heightPx] - –≤—ã—Å–æ—Ç–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ –ø–∏–∫—Å–µ–ª—è—Ö
  /// - [strokeColor] - —Ü–≤–µ—Ç –ª–∏–Ω–∏–∏ –º–∞—Ä—à—Ä—É—Ç–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é AppColors.brandPrimary)
  /// - [strokeWidth] - —à–∏—Ä–∏–Ω–∞ –ª–∏–Ω–∏–∏ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 3)
  /// - [padding] - –æ—Ç—Å—Ç—É–ø—ã –æ—Ç –∫—Ä–∞—ë–≤ –≤ –ø–∏–∫—Å–µ–ª—è—Ö (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 12)
  /// - [maxWidth] - –º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —à–∏—Ä–∏–Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 800px –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏)
  /// - [maxHeight] - –º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –≤—ã—Å–æ—Ç–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 600px –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏)
  ///
  /// –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç URL –¥–ª—è Mapbox Static Images API.
  ///
  /// ‚ö° PERFORMANCE OPTIMIZATION:
  /// - –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ—Ç –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–ª—è —É–º–µ–Ω—å—à–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞ —Ñ–∞–π–ª–∞
  /// - –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –ø—Ä–æ–ø–æ—Ä—Ü–∏–∏ –ø—Ä–∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–∏ —Ä–∞–∑–º–µ—Ä–∞
  static String fromPoints({
    required List<LatLng> points,
    required double widthPx,
    required double heightPx,
    Color? strokeColor,
    double strokeWidth = 3.0,
    double padding = 12.0,
    double? maxWidth,
    double? maxHeight,
  }) {
    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // üîπ –ó–ê–©–ò–¢–ê: –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º edge cases
    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    if (points.isEmpty) {
      throw ArgumentError('points –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º');
    }

    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // üîπ –£–ü–†–û–©–ï–ù–ò–ï –ü–û–õ–ò–õ–ò–ù–ò–ò: –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ —Ä–∞–∑–º–µ—Ä–∞ URL
    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ –∂–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã, —á—Ç–æ –∏ –≤ RouteCard:
    // - tolerance: 5 –º–µ—Ç—Ä–æ–≤ (–±–∞–ª–∞–Ω—Å –º–µ–∂–¥—É –∫–∞—á–µ—Å—Ç–≤–æ–º –∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å—é)
    // - maxPoints: 300 (–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–ª—è –≤–∏–∑—É–∞–ª—å–Ω–æ–≥–æ –∫–∞—á–µ—Å—Ç–≤–∞ –Ω–∞ –º–∞–ª–µ–Ω—å–∫–æ–π –∫–∞—Ä—Ç–µ)
    final simplifiedPoints = PolylineSimplifier.simplify(
      points: points,
      tolerance: 5.0,
      maxPoints: 300,
    );

    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // üîπ –ö–û–î–ò–†–û–í–ê–ù–ò–ï –ü–û–õ–ò–õ–ò–ù–ò–ò: –≤ —Ñ–æ—Ä–º–∞—Ç Google polyline
    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    final encodedPolyline = _encodePolyline(simplifiedPoints);

    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // üîπ –¶–í–ï–¢ –õ–ò–ù–ò–ò: –∏—Å–ø–æ–ª—å–∑—É–µ–º brandPrimary –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    final color = strokeColor ?? AppColors.brandPrimary;
    final colorHex = _colorToHex(color).toUpperCase();

    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // üîπ –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–Ø –†–ê–ó–ú–ï–†–ê: –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã –¥–ª—è —É–º–µ–Ω—å—à–µ–Ω–∏—è –≤–µ—Å–∞ —Ñ–∞–π–ª–∞
    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // –î–ª—è –∫–∞—Ä—Ç–æ—á–µ–∫ –≤ –ª–µ–Ω—Ç–µ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–µ–Ω—å—à–∏—Ö —Ä–∞–∑–º–µ—Ä–æ–≤ (–¥–æ 800x600px)
    // –≠—Ç–æ —É–º–µ–Ω—å—à–∞–µ—Ç —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞ –≤ 2-4 —Ä–∞–∑–∞ –±–µ–∑ –∑–∞–º–µ—Ç–Ω–æ–π –ø–æ—Ç–µ—Ä–∏ –∫–∞—á–µ—Å—Ç–≤–∞
    final effectiveMaxWidth = maxWidth ?? 800.0;
    final effectiveMaxHeight = maxHeight ?? 600.0;

    double finalWidth = widthPx;
    double finalHeight = heightPx;

    // –ï—Å–ª–∏ —Ä–∞–∑–º–µ—Ä—ã –ø—Ä–µ–≤—ã—à–∞—é—Ç –º–∞–∫—Å–∏–º—É–º - –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –ø—Ä–æ–ø–æ—Ä—Ü–∏–π
    if (finalWidth > effectiveMaxWidth || finalHeight > effectiveMaxHeight) {
      final widthRatio = effectiveMaxWidth / finalWidth;
      final heightRatio = effectiveMaxHeight / finalHeight;
      final scale = widthRatio < heightRatio ? widthRatio : heightRatio;

      finalWidth = (finalWidth * scale).roundToDouble();
      finalHeight = (finalHeight * scale).roundToDouble();
    }

    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // üîπ –§–û–†–ú–ò–†–û–í–ê–ù–ò–ï URL: Mapbox Static Images API
    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // –§–æ—Ä–º–∞—Ç: https://api.mapbox.com/styles/v1/mapbox/{style}/static/{overlay}/{lon},{lat},{zoom}/{width}x{height}?access_token={token}
    // –ò–ª–∏ —Å path: https://api.mapbox.com/styles/v1/mapbox/{style}/static/{path-overlay}/auto/{width}x{height}?access_token={token}
    //
    // Path overlay —Ñ–æ—Ä–º–∞—Ç: path-{strokeWidth}+{strokeColor}({encodedPolyline})
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º auto –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ü–µ–Ω—Ç—Ä–∞ –∏ –∑—É–º–∞ –ø–æ –≥—Ä–∞–Ω–∏—Ü–∞–º –º–∞—Ä—à—Ä—É—Ç–∞
    final pathOverlay = 'path-$strokeWidth+$colorHex($encodedPolyline)';
    final encodedPath = Uri.encodeComponent(pathOverlay);

    final width = finalWidth.round();
    final height = finalHeight.round();

    final url = 'https://api.mapbox.com/styles/v1/mapbox/streets-v12/static/$encodedPath/auto/${width}x$height?access_token=${AppConfig.mapboxAccessToken}';

    return url;
  }

  /// –ö–æ–¥–∏—Ä—É–µ—Ç —Å–ø–∏—Å–æ–∫ —Ç–æ—á–µ–∫ –≤ —Ñ–æ—Ä–º–∞—Ç Google polyline (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è Mapbox).
  ///
  /// –ê–ª–≥–æ—Ä–∏—Ç–º –∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è:
  /// 1. –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –≤ —Ü–µ–ª—ã–µ —á–∏—Å–ª–∞ (—É–º–Ω–æ–∂–∞–µ–º –Ω–∞ 1e5)
  /// 2. –í—ã—á–∏—Å–ª—è–µ–º —Ä–∞–∑–Ω–æ—Å—Ç–∏ –º–µ–∂–¥—É —Å–æ—Å–µ–¥–Ω–∏–º–∏ —Ç–æ—á–∫–∞–º–∏ (delta encoding)
  /// 3. –ö–æ–¥–∏—Ä—É–µ–º –∫–∞–∂–¥—É—é —Ä–∞–∑–Ω–æ—Å—Ç—å –≤ base64-–ø–æ–¥–æ–±–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç (ASCII 63 —Å–∏–º–≤–æ–ª–∞)
  static String _encodePolyline(List<LatLng> points) {
    if (points.isEmpty) return '';

    final buffer = StringBuffer();
    int lastLat = 0;
    int lastLng = 0;

    for (final point in points) {
      // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ —Ü–µ–ª—ã–µ —á–∏—Å–ª–∞ (—É–º–Ω–æ–∂–∞–µ–º –Ω–∞ 1e5 –∏ –æ–∫—Ä—É–≥–ª—è–µ–º)
      final lat = (point.latitude * 1e5).round();
      final lng = (point.longitude * 1e5).round();

      // –í—ã—á–∏—Å–ª—è–µ–º —Ä–∞–∑–Ω–æ—Å—Ç–∏ (delta encoding)
      final deltaLat = lat - lastLat;
      final deltaLng = lng - lastLng;

      // –ö–æ–¥–∏—Ä—É–µ–º —Ä–∞–∑–Ω–æ—Å—Ç–∏
      _encodeValue(buffer, deltaLat);
      _encodeValue(buffer, deltaLng);

      lastLat = lat;
      lastLng = lng;
    }

    return buffer.toString();
  }

  /// –ö–æ–¥–∏—Ä—É–µ—Ç –æ–¥–Ω–æ –∑–Ω–∞—á–µ–Ω–∏–µ (—Ä–∞–∑–Ω–æ—Å—Ç—å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç) –≤ —Ñ–æ—Ä–º–∞—Ç Google polyline.
  ///
  /// –ê–ª–≥–æ—Ä–∏—Ç–º:
  /// 1. –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è —á–µ—Ä–µ–∑ –±–∏—Ç–æ–≤—ã–π NOT –∏ —Å–¥–≤–∏–≥
  /// 2. –†–∞–∑–±–∏–≤–∞–µ–º –Ω–∞ 5-–±–∏—Ç–æ–≤—ã–µ –±–ª–æ–∫–∏
  /// 3. –ö–æ–¥–∏—Ä—É–µ–º –∫–∞–∂–¥—ã–π –±–ª–æ–∫ –≤ ASCII —Å–∏–º–≤–æ–ª (63 —Å–∏–º–≤–æ–ª–∞, –Ω–∞—á–∏–Ω–∞—è —Å '?')
  static void _encodeValue(StringBuffer buffer, int value) {
    // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
    // –õ–µ–≤—ã–π —Å–¥–≤–∏–≥ –Ω–∞ 1 –±–∏—Ç, –∑–∞—Ç–µ–º –∏–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –µ—Å–ª–∏ –∑–Ω–∞—á–µ–Ω–∏–µ –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–æ–µ
    int shifted = value << 1;
    if (value < 0) {
      shifted = ~shifted;
    }

    // –†–∞–∑–±–∏–≤–∞–µ–º –Ω–∞ 5-–±–∏—Ç–æ–≤—ã–µ –±–ª–æ–∫–∏ –∏ –∫–æ–¥–∏—Ä—É–µ–º
    while (shifted >= 0x20) {
      // –ë–µ—Ä–µ–º –º–ª–∞–¥—à–∏–µ 5 –±–∏—Ç –∏ –¥–æ–±–∞–≤–ª—è–µ–º 63 (ASCII –∫–æ–¥ '?')
      final char = (0x20 | (shifted & 0x1f)) + 63;
      buffer.writeCharCode(char);
      shifted >>= 5;
    }

    // –ö–æ–¥–∏—Ä—É–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π –±–ª–æ–∫
    final char = shifted + 63;
    buffer.writeCharCode(char);
  }

  /// –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç Color –≤ hex-—Å—Ç—Ä–æ–∫—É –±–µ–∑ –∞–ª—å—Ñ—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä, 379AE6).
  static String _colorToHex(Color color) {
    final r = color.red.toRadixString(16).padLeft(2, '0');
    final g = color.green.toRadixString(16).padLeft(2, '0');
    final b = color.blue.toRadixString(16).padLeft(2, '0');
    return '$r$g$b';
  }
}
