// lib/core/utils/static_map_url_builder.dart
import 'package:latlong2/latlong.dart';
import 'package:flutter/material.dart';
import '../config/app_config.dart';
import '../theme/app_theme.dart';
import 'polyline_simplifier.dart';

/// Ğ£Ñ‚Ğ¸Ğ»Ğ¸Ñ‚Ğ° Ğ´Ğ»Ñ Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸ URL ÑÑ‚Ğ°Ñ‚Ğ¸Ñ‡Ğ½Ñ‹Ñ… ĞºĞ°Ñ€Ñ‚ Mapbox Static Images API.
///
/// Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ÑÑ Ğ´Ğ»Ñ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ñ ÑÑ‚Ğ°Ñ‚Ğ¸Ñ‡Ğ½Ñ‹Ñ… Ğ¸Ğ·Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ğ¹ Ğ¼Ğ°Ñ€ÑˆÑ€ÑƒÑ‚Ğ¾Ğ² Ğ²Ğ¼ĞµÑÑ‚Ğ¾
/// Ğ¸Ğ½Ñ‚ĞµÑ€Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ñ… ĞºĞ°Ñ€Ñ‚ Mapbox GL, Ñ‡Ñ‚Ğ¾ ÑƒÑÑ‚Ñ€Ğ°Ğ½ÑĞµÑ‚ jank Ğ¿Ñ€Ğ¸ ÑĞºÑ€Ğ¾Ğ»Ğ»Ğµ Ğ² Ğ»ĞµĞ½Ñ‚Ğµ.
///
/// âš¡ PERFORMANCE OPTIMIZATION:
/// - Ğ¡Ñ‚Ğ°Ñ‚Ğ¸Ñ‡Ğ½Ñ‹Ğµ PNG ĞºĞ°Ñ€Ñ‚Ğ¸Ğ½ĞºĞ¸ Ğ·Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°ÑÑ‚ÑÑ Ğ±Ñ‹ÑÑ‚Ñ€ĞµĞµ, Ñ‡ĞµĞ¼ GL-Ğ¿Ğ¾Ğ²ĞµÑ€Ñ…Ğ½Ğ¾ÑÑ‚Ğ¸
/// - ĞšĞµÑˆĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ñ‡ĞµÑ€ĞµĞ· CachedNetworkImage ÑĞ½Ğ¸Ğ¶Ğ°ĞµÑ‚ Ğ¿Ğ¾Ğ²Ñ‚Ğ¾Ñ€Ğ½Ñ‹Ğµ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑÑ‹
/// - Ğ£Ğ¿Ñ€Ğ¾Ñ‰ĞµĞ½Ğ¸Ğµ Ğ¿Ğ¾Ğ»Ğ¸Ğ»Ğ¸Ğ½Ğ¸Ğ¸ ÑƒĞ¼ĞµĞ½ÑŒÑˆĞ°ĞµÑ‚ Ñ€Ğ°Ğ·Ğ¼ĞµÑ€ URL Ğ¸ ÑƒÑĞºĞ¾Ñ€ÑĞµÑ‚ Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ñ
class StaticMapUrlBuilder {
  /// Ğ“ĞµĞ½ĞµÑ€Ğ¸Ñ€ÑƒĞµÑ‚ URL Ğ´Ğ»Ñ ÑÑ‚Ğ°Ñ‚Ğ¸Ñ‡Ğ½Ğ¾Ğ¹ ĞºĞ°Ñ€Ñ‚Ñ‹ Mapbox Ñ Ğ¼Ğ°Ñ€ÑˆÑ€ÑƒÑ‚Ğ¾Ğ¼.
  ///
  /// ĞŸĞ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€Ñ‹:
  /// - [points] - ÑĞ¿Ğ¸ÑĞ¾Ğº Ñ‚Ğ¾Ñ‡ĞµĞº Ğ¼Ğ°Ñ€ÑˆÑ€ÑƒÑ‚Ğ° (Ğ±ÑƒĞ´ĞµÑ‚ ÑƒĞ¿Ñ€Ğ¾Ñ‰Ñ‘Ğ½ Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸)
  /// - [widthPx] - ÑˆĞ¸Ñ€Ğ¸Ğ½Ğ° Ğ¸Ğ·Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ñ Ğ² Ğ¿Ğ¸ĞºÑĞµĞ»ÑÑ…
  /// - [heightPx] - Ğ²Ñ‹ÑĞ¾Ñ‚Ğ° Ğ¸Ğ·Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ñ Ğ² Ğ¿Ğ¸ĞºÑĞµĞ»ÑÑ…
  /// - [strokeColor] - Ñ†Ğ²ĞµÑ‚ Ğ»Ğ¸Ğ½Ğ¸Ğ¸ Ğ¼Ğ°Ñ€ÑˆÑ€ÑƒÑ‚Ğ° (Ğ¿Ğ¾ ÑƒĞ¼Ğ¾Ğ»Ñ‡Ğ°Ğ½Ğ¸Ñ AppColors.brandPrimary)
  /// - [strokeWidth] - ÑˆĞ¸Ñ€Ğ¸Ğ½Ğ° Ğ»Ğ¸Ğ½Ğ¸Ğ¸ (Ğ¿Ğ¾ ÑƒĞ¼Ğ¾Ğ»Ñ‡Ğ°Ğ½Ğ¸Ñ 3)
  /// - [padding] - Ğ¾Ñ‚ÑÑ‚ÑƒĞ¿Ñ‹ Ğ¾Ñ‚ ĞºÑ€Ğ°Ñ‘Ğ² Ğ² Ğ¿Ğ¸ĞºÑĞµĞ»ÑÑ… (Ğ¿Ğ¾ ÑƒĞ¼Ğ¾Ğ»Ñ‡Ğ°Ğ½Ğ¸Ñ 12)
  ///
  /// Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ URL Ğ´Ğ»Ñ Mapbox Static Images API.
  static String fromPoints({
    required List<LatLng> points,
    required double widthPx,
    required double heightPx,
    Color? strokeColor,
    double strokeWidth = 3.0,
    double padding = 12.0,
  }) {
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // ğŸ”¹ Ğ—ĞĞ©Ğ˜Ğ¢Ğ: Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ°Ñ‚Ñ‹Ğ²Ğ°ĞµĞ¼ edge cases
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    if (points.isEmpty) {
      throw ArgumentError('points Ğ½Ğµ Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ğ±Ñ‹Ñ‚ÑŒ Ğ¿ÑƒÑÑ‚Ñ‹Ğ¼');
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // ğŸ”¹ Ğ£ĞŸĞ ĞĞ©Ğ•ĞĞ˜Ğ• ĞŸĞĞ›Ğ˜Ğ›Ğ˜ĞĞ˜Ğ˜: Ğ´Ğ»Ñ Ğ¾Ğ¿Ñ‚Ğ¸Ğ¼Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸ Ñ€Ğ°Ğ·Ğ¼ĞµÑ€Ğ° URL
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ Ñ‚Ğµ Ğ¶Ğµ Ğ¿Ğ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€Ñ‹, Ñ‡Ñ‚Ğ¾ Ğ¸ Ğ² RouteCard:
    // - tolerance: 5 Ğ¼ĞµÑ‚Ñ€Ğ¾Ğ² (Ğ±Ğ°Ğ»Ğ°Ğ½Ñ Ğ¼ĞµĞ¶Ğ´Ñƒ ĞºĞ°Ñ‡ĞµÑÑ‚Ğ²Ğ¾Ğ¼ Ğ¸ Ğ¿Ñ€Ğ¾Ğ¸Ğ·Ğ²Ğ¾Ğ´Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ÑÑ‚ÑŒÑ)
    // - maxPoints: 300 (Ğ´Ğ¾ÑÑ‚Ğ°Ñ‚Ğ¾Ñ‡Ğ½Ğ¾ Ğ´Ğ»Ñ Ğ²Ğ¸Ğ·ÑƒĞ°Ğ»ÑŒĞ½Ğ¾Ğ³Ğ¾ ĞºĞ°Ñ‡ĞµÑÑ‚Ğ²Ğ° Ğ½Ğ° Ğ¼Ğ°Ğ»ĞµĞ½ÑŒĞºĞ¾Ğ¹ ĞºĞ°Ñ€Ñ‚Ğµ)
    final simplifiedPoints = PolylineSimplifier.simplify(
      points: points,
      tolerance: 5.0,
      maxPoints: 300,
    );

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // ğŸ”¹ ĞšĞĞ”Ğ˜Ğ ĞĞ’ĞĞĞ˜Ğ• ĞŸĞĞ›Ğ˜Ğ›Ğ˜ĞĞ˜Ğ˜: Ğ² Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚ Google polyline
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    final encodedPolyline = _encodePolyline(simplifiedPoints);

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // ğŸ”¹ Ğ¦Ğ’Ğ•Ğ¢ Ğ›Ğ˜ĞĞ˜Ğ˜: Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ brandPrimary Ğ¿Ğ¾ ÑƒĞ¼Ğ¾Ğ»Ñ‡Ğ°Ğ½Ğ¸Ñ
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    final color = strokeColor ?? AppColors.brandPrimary;
    final colorHex = _colorToHex(color).toUpperCase();

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // ğŸ”¹ Ğ¤ĞĞ ĞœĞ˜Ğ ĞĞ’ĞĞĞ˜Ğ• URL: Mapbox Static Images API
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // Ğ¤Ğ¾Ñ€Ğ¼Ğ°Ñ‚: https://api.mapbox.com/styles/v1/mapbox/{style}/static/{overlay}/{lon},{lat},{zoom}/{width}x{height}?access_token={token}
    // Ğ˜Ğ»Ğ¸ Ñ path: https://api.mapbox.com/styles/v1/mapbox/{style}/static/{path-overlay}/auto/{width}x{height}?access_token={token}
    //
    // Path overlay Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚: path-{strokeWidth}+{strokeColor}({encodedPolyline})
    // Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ auto Ğ´Ğ»Ñ Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¾Ğ³Ğ¾ Ğ¾Ğ¿Ñ€ĞµĞ´ĞµĞ»ĞµĞ½Ğ¸Ñ Ñ†ĞµĞ½Ñ‚Ñ€Ğ° Ğ¸ Ğ·ÑƒĞ¼Ğ° Ğ¿Ğ¾ Ğ³Ñ€Ğ°Ğ½Ğ¸Ñ†Ğ°Ğ¼ Ğ¼Ğ°Ñ€ÑˆÑ€ÑƒÑ‚Ğ°
    final pathOverlay = 'path-$strokeWidth+$colorHex($encodedPolyline)';
    final encodedPath = Uri.encodeComponent(pathOverlay);

    final width = widthPx.round();
    final height = heightPx.round();

    final url = 'https://api.mapbox.com/styles/v1/mapbox/streets-v12/static/$encodedPath/auto/${width}x$height?access_token=${AppConfig.mapboxAccessToken}';

    return url;
  }

  /// ĞšĞ¾Ğ´Ğ¸Ñ€ÑƒĞµÑ‚ ÑĞ¿Ğ¸ÑĞ¾Ğº Ñ‚Ğ¾Ñ‡ĞµĞº Ğ² Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚ Google polyline (Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ÑÑ Mapbox).
  ///
  /// ĞĞ»Ğ³Ğ¾Ñ€Ğ¸Ñ‚Ğ¼ ĞºĞ¾Ğ´Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ:
  /// 1. ĞŸÑ€ĞµĞ¾Ğ±Ñ€Ğ°Ğ·ÑƒĞµĞ¼ ĞºĞ¾Ğ¾Ñ€Ğ´Ğ¸Ğ½Ğ°Ñ‚Ñ‹ Ğ² Ñ†ĞµĞ»Ñ‹Ğµ Ñ‡Ğ¸ÑĞ»Ğ° (ÑƒĞ¼Ğ½Ğ¾Ğ¶Ğ°ĞµĞ¼ Ğ½Ğ° 1e5)
  /// 2. Ğ’Ñ‹Ñ‡Ğ¸ÑĞ»ÑĞµĞ¼ Ñ€Ğ°Ğ·Ğ½Ğ¾ÑÑ‚Ğ¸ Ğ¼ĞµĞ¶Ğ´Ñƒ ÑĞ¾ÑĞµĞ´Ğ½Ğ¸Ğ¼Ğ¸ Ñ‚Ğ¾Ñ‡ĞºĞ°Ğ¼Ğ¸ (delta encoding)
  /// 3. ĞšĞ¾Ğ´Ğ¸Ñ€ÑƒĞµĞ¼ ĞºĞ°Ğ¶Ğ´ÑƒÑ Ñ€Ğ°Ğ·Ğ½Ğ¾ÑÑ‚ÑŒ Ğ² base64-Ğ¿Ğ¾Ğ´Ğ¾Ğ±Ğ½Ñ‹Ğ¹ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚ (ASCII 63 ÑĞ¸Ğ¼Ğ²Ğ¾Ğ»Ğ°)
  static String _encodePolyline(List<LatLng> points) {
    if (points.isEmpty) return '';

    final buffer = StringBuffer();
    int lastLat = 0;
    int lastLng = 0;

    for (final point in points) {
      // ĞŸÑ€ĞµĞ¾Ğ±Ñ€Ğ°Ğ·ÑƒĞµĞ¼ Ğ² Ñ†ĞµĞ»Ñ‹Ğµ Ñ‡Ğ¸ÑĞ»Ğ° (ÑƒĞ¼Ğ½Ğ¾Ğ¶Ğ°ĞµĞ¼ Ğ½Ğ° 1e5 Ğ¸ Ğ¾ĞºÑ€ÑƒĞ³Ğ»ÑĞµĞ¼)
      final lat = (point.latitude * 1e5).round();
      final lng = (point.longitude * 1e5).round();

      // Ğ’Ñ‹Ñ‡Ğ¸ÑĞ»ÑĞµĞ¼ Ñ€Ğ°Ğ·Ğ½Ğ¾ÑÑ‚Ğ¸ (delta encoding)
      final deltaLat = lat - lastLat;
      final deltaLng = lng - lastLng;

      // ĞšĞ¾Ğ´Ğ¸Ñ€ÑƒĞµĞ¼ Ñ€Ğ°Ğ·Ğ½Ğ¾ÑÑ‚Ğ¸
      _encodeValue(buffer, deltaLat);
      _encodeValue(buffer, deltaLng);

      lastLat = lat;
      lastLng = lng;
    }

    return buffer.toString();
  }

  /// ĞšĞ¾Ğ´Ğ¸Ñ€ÑƒĞµÑ‚ Ğ¾Ğ´Ğ½Ğ¾ Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğµ (Ñ€Ğ°Ğ·Ğ½Ğ¾ÑÑ‚ÑŒ ĞºĞ¾Ğ¾Ñ€Ğ´Ğ¸Ğ½Ğ°Ñ‚) Ğ² Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚ Google polyline.
  ///
  /// ĞĞ»Ğ³Ğ¾Ñ€Ğ¸Ñ‚Ğ¼:
  /// 1. ĞŸÑ€ĞµĞ¾Ğ±Ñ€Ğ°Ğ·ÑƒĞµĞ¼ Ğ¾Ñ‚Ñ€Ğ¸Ñ†Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ğµ Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ñ Ñ‡ĞµÑ€ĞµĞ· Ğ±Ğ¸Ñ‚Ğ¾Ğ²Ñ‹Ğ¹ NOT Ğ¸ ÑĞ´Ğ²Ğ¸Ğ³
  /// 2. Ğ Ğ°Ğ·Ğ±Ğ¸Ğ²Ğ°ĞµĞ¼ Ğ½Ğ° 5-Ğ±Ğ¸Ñ‚Ğ¾Ğ²Ñ‹Ğµ Ğ±Ğ»Ğ¾ĞºĞ¸
  /// 3. ĞšĞ¾Ğ´Ğ¸Ñ€ÑƒĞµĞ¼ ĞºĞ°Ğ¶Ğ´Ñ‹Ğ¹ Ğ±Ğ»Ğ¾Ğº Ğ² ASCII ÑĞ¸Ğ¼Ğ²Ğ¾Ğ» (63 ÑĞ¸Ğ¼Ğ²Ğ¾Ğ»Ğ°, Ğ½Ğ°Ñ‡Ğ¸Ğ½Ğ°Ñ Ñ '?')
  static void _encodeValue(StringBuffer buffer, int value) {
    // ĞŸÑ€ĞµĞ¾Ğ±Ñ€Ğ°Ğ·ÑƒĞµĞ¼ Ğ¾Ñ‚Ñ€Ğ¸Ñ†Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ğµ Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ñ
    // Ğ›ĞµĞ²Ñ‹Ğ¹ ÑĞ´Ğ²Ğ¸Ğ³ Ğ½Ğ° 1 Ğ±Ğ¸Ñ‚, Ğ·Ğ°Ñ‚ĞµĞ¼ Ğ¸Ğ½Ğ²ĞµÑ€Ñ‚Ğ¸Ñ€ÑƒĞµĞ¼ ĞµÑĞ»Ğ¸ Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğµ Ğ¾Ñ‚Ñ€Ğ¸Ñ†Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ğ¾Ğµ
    int shifted = value << 1;
    if (value < 0) {
      shifted = ~shifted;
    }

    // Ğ Ğ°Ğ·Ğ±Ğ¸Ğ²Ğ°ĞµĞ¼ Ğ½Ğ° 5-Ğ±Ğ¸Ñ‚Ğ¾Ğ²Ñ‹Ğµ Ğ±Ğ»Ğ¾ĞºĞ¸ Ğ¸ ĞºĞ¾Ğ´Ğ¸Ñ€ÑƒĞµĞ¼
    while (shifted >= 0x20) {
      // Ğ‘ĞµÑ€ĞµĞ¼ Ğ¼Ğ»Ğ°Ğ´ÑˆĞ¸Ğµ 5 Ğ±Ğ¸Ñ‚ Ğ¸ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ 63 (ASCII ĞºĞ¾Ğ´ '?')
      final char = (0x20 | (shifted & 0x1f)) + 63;
      buffer.writeCharCode(char);
      shifted >>= 5;
    }

    // ĞšĞ¾Ğ´Ğ¸Ñ€ÑƒĞµĞ¼ Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½Ğ¸Ğ¹ Ğ±Ğ»Ğ¾Ğº
    final char = shifted + 63;
    buffer.writeCharCode(char);
  }

  /// ĞŸÑ€ĞµĞ¾Ğ±Ñ€Ğ°Ğ·ÑƒĞµÑ‚ Color Ğ² hex-ÑÑ‚Ñ€Ğ¾ĞºÑƒ Ğ±ĞµĞ· Ğ°Ğ»ÑŒÑ„Ñ‹ (Ğ½Ğ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€, 379AE6).
  static String _colorToHex(Color color) {
    final r = color.red.toRadixString(16).padLeft(2, '0');
    final g = color.green.toRadixString(16).padLeft(2, '0');
    final b = color.blue.toRadixString(16).padLeft(2, '0');
    return '$r$g$b';
  }
}
