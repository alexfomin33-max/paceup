import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import '../service/auth_service.dart';
import '../theme/colors.dart';
import '../providers/lenta/lenta_provider.dart';

/// ๐น SplashScreen โ ััะฐััะพะฒัะน ัะบัะฐะฝ ะฟัะธะปะพะถะตะฝะธั, ะพัะพะฑัะฐะถะฐะตััั ะฟัะธ ะทะฐะฟััะบะต
/// ะัะฟะพะปัะทัะตััั ะดะปั ะฟัะพะฒะตัะบะธ ะฐะฒัะพัะธะทะฐัะธะธ ะฟะพะปัะทะพะฒะฐัะตะปั ะธ ะฟะตัะตะฝะฐะฟัะฐะฒะปะตะฝะธั
/// ะฝะฐ ัะพะพัะฒะตัััะฒัััะธะน ัะบัะฐะฝ (HomeScreen ะธะปะธ HomeShell)
///
/// โก ะะะขะะะะะะฆะะฏ:
/// - ะะปะฐะฒะฝะฐั fade-in ะฐะฝะธะผะฐัะธั ะปะพะณะพัะธะฟะฐ (800ms) ะดะปั ะฟัะพัะตััะธะพะฝะฐะปัะฝะพะณะพ ะฒะธะดะฐ
/// - ะัะตะดะทะฐะณััะทะบะฐ ะดะฐะฝะฝัั ะปะตะฝัั ะะ ะฟะตัะตัะพะดะฐ ะฝะฐ ัะบัะฐะฝ (ะฟะฐัะฐะปะปะตะปัะฝะพ ั ะฐะฝะธะผะฐัะธะตะน)
/// - Offline-first ะฟะพะดัะพะด: ะฟะพะบะฐะทัะฒะฐะตะผ ะบัั ะผะณะฝะพะฒะตะฝะฝะพ, ะพะฑะฝะพะฒะปัะตะผ ะฒ ัะพะฝะต
/// - ะะฐะดะตัะถะบะฐ 2000ms ะดะพััะฐัะพัะฝะฐ ะดะปั ะทะฐะณััะทะบะธ ะฟะตัะฒะพะน ะฟะพััะธะธ ะฟะพััะพะฒ
class SplashScreen extends ConsumerStatefulWidget {
  const SplashScreen({super.key});

  @override
  ConsumerState<SplashScreen> createState() => _SplashScreenState();
}

/// ๐น State ะดะปั SplashScreen
/// ะกะพะดะตัะถะธั ะปะพะณะธะบั ะฟัะพะฒะตัะบะธ ะฐะฒัะพัะธะทะฐัะธะธ, ะฝะฐะฒะธะณะฐัะธะธ ะธ ะฟัะตะดะทะฐะณััะทะบะธ ะดะฐะฝะฝัั
/// SingleTickerProviderStateMixin โ ะดะปั ะฐะฝะธะผะฐัะธะธ fade-in ะปะพะณะพัะธะฟะฐ
class _SplashScreenState extends ConsumerState<SplashScreen>
    with SingleTickerProviderStateMixin {
  // ๐น ะกะตัะฒะธั ะดะปั ัะฐะฑะพัั ั ะฐะฒัะพัะธะทะฐัะธะตะน (ะฟัะพะฒะตัะบะฐ ัะพะบะตะฝะฐ, ะฟะพะปััะตะฝะธะต userId)
  final AuthService auth = AuthService();

  // โโโโโโโโโโโโโโโโโโโโโโโโโโ ะะฝะธะผะฐัะธั โโโโโโโโโโโโโโโโโโโโโโโโโโ
  /// ๐น ะะพะฝััะพะปะปะตั ะฐะฝะธะผะฐัะธะธ ะดะปั fade-in ัััะตะบัะฐ ะปะพะณะพัะธะฟะฐ
  late AnimationController _animationController;

  /// ๐น ะะฝะธะผะฐัะธั ะฟัะพะทัะฐัะฝะพััะธ (ะพั 0.0 ะดะพ 1.0)
  late Animation<double> _fadeAnimation;

  @override
  void initState() {
    super.initState();

    // โโโโโโโโโโโโโโโโโโโโโโโโโโ ะะฝะธัะธะฐะปะธะทะฐัะธั ะฐะฝะธะผะฐัะธะธ โโโโโโโโโโโโโโโโโโโโโโโโโโ
    // ๐น ะกะพะทะดะฐะตะผ ะบะพะฝััะพะปะปะตั ะฐะฝะธะผะฐัะธะธ ั ะดะปะธัะตะปัะฝะพัััั 800ms
    _animationController = AnimationController(
      duration: const Duration(milliseconds: 800),
      vsync: this,
    );

    // ๐น ะกะพะทะดะฐะตะผ ะฟะปะฐะฒะฝัั ะฐะฝะธะผะฐัะธั ะฟัะพะทัะฐัะฝะพััะธ ั ease-in ะบัะธะฒะพะน
    _fadeAnimation = CurvedAnimation(
      parent: _animationController,
      curve: Curves.easeIn,
    );

    // ๐น ะะฐะฟััะบะฐะตะผ ะฐะฝะธะผะฐัะธั fade-in
    _animationController.forward();

    // โโโโโโโโโโโโโโโโโโโโโโโโโโ ะัะพะฒะตัะบะฐ ะฐะฒัะพัะธะทะฐัะธะธ โโโโโโโโโโโโโโโโโโโโโโโโโโ
    _checkAuth(); // ๐น ะัะพะฒะตััะตะผ ะฐะฒัะพัะธะทะฐัะธั ััะฐะทั ะฟะพัะปะต ะธะฝะธัะธะฐะปะธะทะฐัะธะธ ัะบัะฐะฝะฐ
  }

  @override
  void dispose() {
    // ๐น ะัะธัะฐะตะผ ัะตััััั ะบะพะฝััะพะปะปะตัะฐ ะฐะฝะธะผะฐัะธะธ
    _animationController.dispose();
    super.dispose();
  }

  /// ๐น ะะตัะพะด ะฟัะพะฒะตัะบะธ ะฐะฒัะพัะธะทะฐัะธะธ ะธ ะฟัะตะดะทะฐะณััะทะบะธ ะดะฐะฝะฝัั
  /// 1. ะัะพะฒะตััะตั, ะตััั ะปะธ ะฒะฐะปะธะดะฝัะน ัะพะบะตะฝ
  /// 2. ะัะปะธ ะฐะฒัะพัะธะทะพะฒะฐะฝ, ะฟะพะปััะฐะตั userId
  /// 3. ๐ ะะะะฃะกะะะะข ะะะะะะะะะฃะะะฃ ะะะะขะซ (ะฟะฐัะฐะปะปะตะปัะฝะพ ั ะฐะฝะธะผะฐัะธะตะน)
  /// 4. ะะตัะตะฝะฐะฟัะฐะฒะปัะตั ะฝะฐ ัะพะพัะฒะตัััะฒัััะธะน ัะบัะฐะฝ
  ///
  /// โก ะะะขะะะะะะฆะะฏ:
  /// - ะฃะฒะตะปะธัะตะฝะฐ ะทะฐะดะตัะถะบะฐ ะดะพ 2000ms (2 ัะตะบัะฝะดั) ะดะปั ะบะพะผัะพััะฝะพะน ะทะฐะณััะทะบะธ ะดะฐะฝะฝัั
  /// - ะัะตะดะทะฐะณััะทะบะฐ ะดะฐะฝะฝัั ัะตัะตะท Riverpod provider ะะ ะฟะตัะตัะพะดะฐ ะฝะฐ ัะบัะฐะฝ
  /// - Offline-first: ะบัั ะฟะพะบะฐะทัะฒะฐะตััั ะผะณะฝะพะฒะตะฝะฝะพ (~50ms), ัะฒะตะถะธะต ะดะฐะฝะฝัะต ะฟะพะดะณััะถะฐัััั ะฒ ัะพะฝะต
  /// - ะะฐ ััะพ ะฒัะตะผั ััะฟะตะฒะฐะตั: ะทะฐะฒะตััะธัััั fade-in ะฐะฝะธะผะฐัะธั (800ms) + ะฟัะพะณััะทะธัััั ะปะตะฝัะฐ (~1000ms)
  /// - ะัะธ ะฟะตัะตัะพะดะต ะฝะฐ ะะตะฝัั ะดะฐะฝะฝัะต ัะถะต ะทะฐะณััะถะตะฝั ะธะท ะบััะฐ
  Future<void> _checkAuth() async {
    // โโโโโโโโโโ ะจะะ 1: ะัะพะฒะตััะตะผ ะฐะฒัะพัะธะทะฐัะธั โโโโโโโโโโ
    final bool authorized = await auth.isAuthorized();
    if (!mounted) return;

    int? userId;
    
    if (authorized) {
      // ๐น ะะพะปััะฐะตะผ userId
      userId = await auth.getUserId();
      if (!mounted) return;
    }

    // โโโโโโโโโโ ะจะะ 2: ะัะตะดะทะฐะณััะถะฐะตะผ ะดะฐะฝะฝัะต ะปะตะฝัั โโโโโโโโโโ
    // ๐ ะะะะขะะงะะซะ ะะะะะะข: ะทะฐะฟััะบะฐะตะผ ะทะฐะณััะทะบั ะะ ะฟะตัะตัะพะดะฐ ะฝะฐ ัะบัะฐะฝ
    // ะญัะพ ะดะฐัั offline-first ัััะตะบั - ะดะฐะฝะฝัะต ะธะท ะบััะฐ ะฟะพะบะฐะทัะฒะฐัััั ะผะณะฝะพะฒะตะฝะฝะพ
    if (userId != null) {
      debugPrint('๐ ะัะตะดะทะฐะณััะทะบะฐ ะดะฐะฝะฝัั ะปะตะฝัั ะดะปั userId: $userId');
      
      // ะะฐะฟััะบะฐะตะผ ะฟัะตะดะทะฐะณััะทะบั ะธ ะทะฐะดะตัะถะบั ะฟะฐัะฐะปะปะตะปัะฝะพ
      await Future.wait([
        // ะะฐะณััะถะฐะตะผ ะดะฐะฝะฝัะต ัะตัะตะท ะฟัะพะฒะฐะนะดะตั
        ref.read(lentaProvider(userId).notifier).loadInitial(),
        // ะะฐะดะตัะถะบะฐ ะดะปั ะฐะฝะธะผะฐัะธะธ
        Future.delayed(const Duration(milliseconds: 2000)),
      ]);
      
      debugPrint('โ ะะฐะฝะฝัะต ะปะตะฝัั ะฟัะตะดะทะฐะณััะถะตะฝั, ะฟะตัะตัะพะดะธะผ ะฝะฐ ัะบัะฐะฝ');
    } else {
      // ะัะปะธ userId ะฝะตั, ะฟัะพััะพ ะถะดัะผ ะทะฐะฒะตััะตะฝะธั ะฐะฝะธะผะฐัะธะธ
      await Future.delayed(const Duration(milliseconds: 2000));
    }

    if (!mounted) return;

    // โโโโโโโโโโ ะจะะ 3: ะะตัะตัะพะดะธะผ ะฝะฐ ัะบัะฐะฝ โโโโโโโโโโ
    if (userId != null) {
      // ๐น ะะตัะตัะพะดะธะผ ะฝะฐ ะปะตะฝัั ั ะฟัะตะดะทะฐะณััะถะตะฝะฝัะผะธ ะดะฐะฝะฝัะผะธ
      Navigator.pushReplacementNamed(
        context,
        '/lenta',
        arguments: {'userId': userId},
      );
    } else {
      // ๐น fallback: ะฟะตัะตัะพะดะธะผ ะฑะตะท userId
      Navigator.pushReplacementNamed(context, '/lenta');
    }
  }

  @override
  Widget build(BuildContext context) {
    // ๐น ะะพะบะฐ ะธะดะตั ะฟัะพะฒะตัะบะฐ ะฐะฒัะพัะธะทะฐัะธะธ, ะฟะพะบะฐะทัะฒะฐะตะผ ะปะพะณะพัะธะฟ ั fade-in ะฐะฝะธะผะฐัะธะตะน
    return Scaffold(
      backgroundColor: AppColors.surface,
      body: Center(
        child: FadeTransition(
          opacity: _fadeAnimation,
          child: Image.asset(
            'assets/logo.png',
            width: 150,
            height: 150,
            // ๐น ะกะพััะฐะฝัะตะผ ะบะฐัะตััะฒะพ ะปะพะณะพัะธะฟะฐ ะฟัะธ ะผะฐัััะฐะฑะธัะพะฒะฐะฝะธะธ
            filterQuality: FilterQuality.high,
          ),
        ),
      ),
    );
  }
}
